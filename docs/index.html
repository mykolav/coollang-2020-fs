<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>A toy compiler of a small Scala subset</title>
  <style>
    /* Adapted from https://github.com/evermade/support-ukraine-banner */
    body {
        margin-top: 35px;
    }

    .support-ukraine,
    .support-ukraine:visited {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        background: rgb(0, 0, 0);
        display: flex;
        justify-content: center;
        padding-top: 5px;
        padding-bottom: 5px;
        z-index: 10000;
        text-decoration: none;
        font-family: arial;
    }

    .support-ukraine:hover,
    .support-ukraine:active {
        background: black;
        display: flex;
        background: rgb(80, 80, 80);
        text-decoration: none;
    }

    .support-ukraine__flag {
        height: 25px;
        margin-right: 10px;
    }

    .support-ukraine__flag__blue {
        width: 40px;
        height: 12.5px;
        background: #005BBB;
    }

    .support-ukraine__flag__yellow {
        width: 40px;
        height: 12.5px;
        background: #FFD500;
    }

    .support-ukraine__label {
        color: white;
        font-size: 12px;
        line-height: 25px;
    }

    .github-corner:hover .octo-arm {
        animation: octocat-wave 560ms ease-in-out;
    }

    @keyframes octocat-wave {
        0% {
            transform: rotate(0deg);
        }

        20% {
            transform: rotate(-25deg);
        }

        40% {
            transform: rotate(10deg);
        }

        60% {
            transform: rotate(-25deg);
        }

        80% {
            transform: rotate(10deg);
        }

        100% {
            transform: rotate(0deg);
        }
    }

    @media (max-width: 500px) {
        .github-corner:hover .octo-arm {
            animation: none;
        }

        .github-corner .octo-arm {
            animation: octocat-wave 560ms ease-in-out;
        }
    }
    
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="styles.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <a class="support-ukraine" href="https://war.ukraine.ua/support-ukraine/" target="_blank" rel="nofollow noopener"
    title="Support Ukraine.">
    <div class="support-ukraine__flag" role="img" aria-label="Flag of Ukraine">
        <div class="support-ukraine__flag__blue"></div>
        <div class="support-ukraine__flag__yellow"></div>
    </div>
    <div class="support-ukraine__label">
        russia is waging a genocidal war in Ukraine. Please help Ukraine defend itself before russia has a chance to invade other countries.
    </div>
  </a>
  <!-- The GitHub corner -->
  <a href="https://github.com/mykolav/coollang-2020-fs" class="github-corner" aria-label="View the source on GitHub">
    <svg width="80" height="80" viewBox="0 0 250 250" style="position: fixed; top: 0px; right: 0px; border: 0px; z-index: 10001;"
        aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" fill="#151513"></path>
        <path class="octo-arm"
              d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="#ffffff" style="transform-origin: 130px 106px;"></path>
        <path class="octo-body"
              d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="#ffffff"></path>
    </svg>
  </a>
</head>
<body>
<header id="title-block-header">
<h1 class="title">A toy compiler of a small Scala subset</h1>
</header>
<blockquote>
<p>üêå<br />
Yours truly is not an expert in compilers but does enjoy diving into
this topic and learning something new from time to time.</p>
</blockquote>
<p>Why write another toy compiler? First and foremost, because it‚Äôs a
lot of fun. Also learning a great deal along the way comes with the
package. Learning not only in terms of technical skills but also in
terms of managing a project‚Äôs scope, complexity, and ultimately
delivering a working program implementing the original idea.</p>
<p>As someone who finds these reasons compelling, <a
href="https://github.com/mykolav/coollang-2020-fs">I developed a hobby
compiler too</a>. Read on to find out about things that might set this
one apart.</p>
<figure>
<img src="./images/complexity-of-toy-compiler-design.png"
alt="Not exactly the Dragon Book‚Äôs cover‚Ä¶" />
<figcaption aria-hidden="true">Not exactly the Dragon Book‚Äôs
cover‚Ä¶</figcaption>
</figure>
<ul>
<li><a href="#a-taste-of-the-language">A taste of the language</a>
<ul>
<li><a
href="#the-language-is-concise-but-retains-a-degree-of-expressivity">The
language is concise but retains a degree of expressivity</a></li>
</ul></li>
<li><a href="#a-couple-words-about-the-implementation">A couple words
about the implementation</a>
<ul>
<li><a href="#it-is-cross-platform">It is cross-platform</a></li>
<li><a href="#the-test-suite">The test suite</a></li>
<li><a
href="#maybe-the-only-hobby-compiler-that-has-a-demo-video-">Maybe the
only hobby-compiler that has a demo video :)</a></li>
</ul></li>
<li><a href="#a-crucial-design-decision-compile-time-errors-handling">A
crucial design decision: compile time errors handling</a>
<ul>
<li><a href="#stop-on-the-first-error">Stop on the first error</a></li>
<li><a href="#try-to-discover-the-maximum-number-of-errors">Try to
discover the maximum number of errors</a></li>
<li><a href="#a-hybrid-approach">A hybrid approach</a></li>
</ul></li>
<li><a href="#parsing">Parsing</a></li>
<li><a href="#emitting-assembly">Emitting assembly</a>
<ul>
<li><a href="#human-readable-assembly">Human-readable assembly</a></li>
<li><a href="#register-allocation">Register allocation</a></li>
</ul></li>
<li><a href="#runtime-library">Runtime library</a>
<ul>
<li><a href="#runtime-library-source-code-structure">Runtime library
source code structure</a></li>
<li><a href="#the-entry-point">The entry point</a></li>
</ul></li>
<li><a href="#learning-resources">Learning resources</a>
<ul>
<li><a href="#crafting-interpreters">Crafting Interpreters</a></li>
<li><a
href="#introduction-to-compilers-and-language-design">Introduction to
Compilers and Language Design</a></li>
<li><a
href="#building-a-compiler-video-series-by-immo-landwerth">Building a
Compiler video series by Immo Landwerth</a></li>
<li><a
href="#cs-6120-advanced-compilers-the-self-guided-online-course">CS
6120: Advanced Compilers: The Self-Guided Online Course</a></li>
<li><a href="#llvm-ir-tutorial---phis-geps-">LLVM IR Tutorial - Phis,
GEPs ‚Ä¶</a></li>
</ul></li>
<li><a href="#looking-to-implement-a-compiler-yourself">Looking to
implement a compiler yourself?</a>
<ul>
<li><a href="#do-not-start-with-classics-textbooks">Do not start with
classics textbooks</a></li>
<li><a href="#dont-try-to-come-up-with-your-own-language-just-yet">Don‚Äôt
try to come up with your own language just yet</a></li>
<li><a href="#stay-focused">Stay focused</a></li>
</ul></li>
</ul>
<h1 id="a-taste-of-the-language">A taste of the language</h1>
<p>Code calculating a portion of the Fibonacci sequence looks like
this:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode scala"><code class="sourceCode scala"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="fu">Fib</span><span class="op">()</span> <span class="kw">extends</span> <span class="fu">IO</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">fib</span><span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="dv">0</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="dv">1</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="fu">fib</span><span class="op">(</span>x <span class="op">-</span> <span class="dv">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu">fib</span><span class="op">(</span>x <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> i<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>i <span class="op">&lt;=</span> <span class="dv">10</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">out_string</span><span class="op">(</span><span class="st">&quot;fib(&quot;</span><span class="op">);</span> <span class="fu">out_int</span><span class="op">(</span>i<span class="op">);</span> <span class="fu">out_string</span><span class="op">(</span><span class="st">&quot;) = &quot;</span><span class="op">);</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">out_int</span><span class="op">(</span><span class="fu">fib</span><span class="op">(</span>i<span class="op">));</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">out_nl</span><span class="op">();</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>      i <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="fu">Main</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span> <span class="kw">new</span> <span class="fu">Fib</span><span class="op">()</span> <span class="op">};</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Or take a look at the sources of <a
href="https://github.com/mykolav/coollang-2020-fs/blob/35d603c54392d94efef41540a48f50fe25c51ba5/src/Tests/CoolPrograms/Runtime/Life.cool">Conway‚Äôs
Game of Life</a></p>
<h2
id="the-language-is-concise-but-retains-a-degree-of-expressivity">The
language is concise but retains a degree of expressivity</h2>
<p><a
href="https://web.archive.org/web/20210823043833/http://www.cs.uwm.edu/classes/cs654/handout/cool-manual.pdf">Cool
2020</a> is a small Scala subset which can be implemented in a
time-frame reasonable for a hobby compiler. Although concise, the
language is quite expressive ‚Äî the features include:</p>
<ul>
<li>Classes</li>
<li>Inheritance</li>
<li>Virtual dispatch</li>
<li>And even a very simple form of pattern matching</li>
</ul>
<p>These represent exciting compiler design and implementation
challenges. Cool 2020 is statically typed, which again leads to
interesting implications for design and implementation.</p>
<p>The language being a Scala subset, tools for Scala code syntax
highlighting, formatting, and editing work out of the box. A Cool 2020
program can be (with just a little bit of <a
href="https://mykolam.net/posts/toy-compiler-of-scala-subset/5-cool2020-scala-adapter/">scaffolding
code</a>) compiled by a Scala compiler or executed in <a
href="https://scastie.scala-lang.org/">an online playground</a>.</p>
<h1 id="a-couple-words-about-the-implementation">A couple words about
the implementation</h1>
<h2 id="it-is-cross-platform">It is cross-platform</h2>
<p>The two supported hosts are x86-64 Windows and Linux. And in general,
the project is based on cross-platform technologies. The compiler itself
runs on .NET. The GNU tools <code>as</code> and <code>ld</code> are
available on Linux and Windows (and many, many other, of course). The
language‚Äôs runtime is implemented in assembly and is split up into three
parts: the majority of code is in a common source file, Windows-specific
bits, and Linux-specific bits that are responsible for calling Windows
API and Linux system functions reside in their respective source
files.</p>
<h2 id="the-test-suite">The test suite</h2>
<p>Approximately 288 automated tests make up <a
href="https://github.com/mykolav/coollang-2020-fs/tree/master/src/Tests">the
test suite</a>. One nice consequence of generating native executables is
an automated test can compile a program, run it, and compare the
program‚Äôs output to the expected values. Out of the 288 tests, there are
<a
href="https://github.com/mykolav/coollang-2020-fs/tree/master/src/Tests/CoolPrograms/Runtime">39
that do exactly that</a>.</p>
<h2 id="maybe-the-only-hobby-compiler-that-has-a-demo-video">Maybe the
only hobby-compiler that has a demo video :)</h2>
<p>Here‚Äôs how compiling a hello world looks like.</p>
<figure>
<img src="./images/compilation-session-demo.gif#center"
alt="A compilation session demo" />
<figcaption aria-hidden="true">A compilation session demo</figcaption>
</figure>
<h1 id="a-crucial-design-decision-compile-time-errors-handling">A
crucial design decision: compile time errors handling</h1>
<p>Reporting errors encountered in the user‚Äôs code is an essential
function of a compiler. Spending some time upfront to think though this
aspects of compiler design is well worth it. As the decision has a
significant impact on the compiler‚Äôs mechanics and code. So, it‚Äôs great
to have a set of explicit, coherent assumptions in mind when working on
the implementation.</p>
<h2 id="stop-on-the-first-error">Stop on the first error</h2>
<p>The compiler can display an error message and stop the translation
once it runs into the first error. This is arguably the simplest
error-handling strategy to implement. It has an obvious downside. If a
program contains multiple errors, this strategy makes the user go
through an equal number of correct the error / restart compilation
iterations to catch them all. The user experience might not necessarily
be ideal in this case.</p>
<h2 id="try-to-discover-the-maximum-number-of-errors">Try to discover
the maximum number of errors</h2>
<p>At the other end of the spectrum, a compiler can attempt to identify
and report as many errors in the code as possible within a single run.
When such a compiler detects an error it informs the user but, instead
of stopping, it keeps going over the code. With the aim of keeping the
number of times the user has to restart compilation to a minimum ‚Äî only
one restart is required in the best-case scenario. While this strategy
sounds a lot nicer it‚Äôs not without problems either.</p>
<h3 id="cascading-errors">Cascading errors</h3>
<p>It leads to a notable increase in the compiler‚Äôs code complexity, as
the compiler has to employ heuristics reducing cascading errors. What‚Äôs
a cascading error? In the Scala code sample below, there‚Äôs <em>one</em>
error ‚Äî the closing parenthesis is missing in line 2.</p>
<div class="sourceCode" id="cb2" data-linenos="true"><pre
class="sourceCode scala"><code class="sourceCode scala"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CascadingError <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">force</span><span class="op">(:</span> <span class="bu">Unit</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span>  </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>But the Scala compiler <a
href="https://scastie.scala-lang.org/sBJyZ6WWSHeYWzx2daD9XA">diagnoses
<em>two</em> errors</a>. After seeing the first, real one it gets
‚Äúconfused‚Äù and reports the second error in line 3 where there is no
actual problem with the code. This is an example of cascading error.</p>
<pre><code>CascadingError.scala:2: error: identifier expected but &#39;:&#39; found.  
    def speak(: Unit = {  
              ^
CascadingError.scala:3: error: &#39;:&#39; expected but &#39;;&#39; found.  
    };  
     ^</code></pre>
<p>In some cases, cascading errors make diagnostic messages so noisy, <a
href="https://stackoverflow.com/questions/27493895/make-scala-compiler-stop-on-first-error">users
start looking for a way to make the compiler stop after the first
encountered error</a>. The effort necessary to tell real errors from
cascading errors can degrade the user experience to such a degree as to
defy the entire point of reporting maximum number of error in one
go.</p>
<h2 id="a-hybrid-approach">A hybrid approach</h2>
<p>Some compilers aim to integrate the strong sides of both approaches
by following a middle-of-the-road error handling strategy. Translation
of a program from the input language into the target one typically
happens over a number of stages. For an educational compiler these
stages can look like this.</p>
<ul>
<li>Lexical analysis, or simply lexing</li>
<li>Syntactic analysis, or parsing</li>
<li>Semantic analysis</li>
<li>Emitting x86-64 assembly</li>
</ul>
<p>(What about a production-grade compiler? C# compiler has <a
href="https://docs.microsoft.com/en-us/archive/blogs/ericlippert/how-many-passes">more
than 20 compilation stages</a>)</p>
<p>The idea is to diagnose as many errors in the input code as possible
within one compilation stage. The key difference with the approach of
detecting maximum errors per a compilation is that the next compilation
stage will only start if no errors are found at the current one.</p>
<p>At the lexical analysis stage, if the lexer encounters a portion of
the source that doesn‚Äôt correspond to any valid token, an error is
reported to the users and lexing continues. But parsing isn‚Äôt going to
start, the compiler will stop once lexing is complete.</p>
<p>Similarly, if the parser encounters a syntactic error, it‚Äôs reported
to the user and parsing continues. Once syntactic analysis is complete,
the compiler will stop instead of moving on to the semantic analysis
stage.</p>
<p>In contrast, the C# compiler performs lexing and parsing at the same
time. If the lexer doesn‚Äôt recognize a token, the parser handles this
scenario and keeps going anyway. But semantic analysis will not start if
lexical or syntactic errors have been encountered in the input code. In
such a case, translation terminates.</p>
<p>And so on.</p>
<h3 id="c-compiler-as-an-example">C# compiler as an example</h3>
<p>A great example of going this way is the C# compiler. Here‚Äôs <a
href="https://stackoverflow.com/a/4698306/818321">a short
description</a> Eric Lippert gave on StackOverflow:</p>
<blockquote>
<p>Briefly, the way the compiler works is it tries to get the program
through a series of stages [‚Ä¶]</p>
<p>The idea is that if an early stage gets an error, we might not be
able to successfully complete a later stage without (1) going into an
infinite loop, (2) crashing, or (3) reporting crazy ‚Äúcascading‚Äù errors.
So what happens is, you get one error, you fix it, and then suddenly the
next stage of compilation can run, and it finds a bunch more errors.</p>
<p>[‚Ä¶]</p>
<p>The up side of this design is that (1) you get the errors that are
the most ‚Äúfundamental‚Äù first, without a lot of noisy, crazy cascading
errors, and (2) the compiler is more robust because it doesn‚Äôt have to
try to do analysis on programs where the basic invariants of the
language are broken. The down side is of course your scenario: that you
have fifty errors, you fix them all, and suddenly fifty more appear.</p>
</blockquote>
<p>Finally, let‚Äôs see how this idea is represented in <a
href="https://github.com/dotnet/roslyn/blob/80e9227e49088d53eda930ecdee87a82c665ffd1/src/Compilers/Core/Portable/CommandLine/CommonCompiler.cs#L929">the
C# compiler‚Äôs source code</a>. The method <code>CompileAndEmit</code> of
the class <code>Microsoft.CodeAnalysis.CommonCompiler</code> coordinates
compilation of C# and VB.NET source code.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Perform all the work associated with actual compilation</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// (parsing, binding, compile, emit), resulting in diagnostics</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// and analyzer output.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">CompileAndEmit</span><span class="op">(</span><span class="co">/*[...]*/</span><span class="op">)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    analyzerCts <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    reportAnalyzer <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    analyzerDriver <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Print the diagnostics produced during the parsing stage and exit if there were any errors.</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    compilation<span class="op">.</span><span class="fu">GetDiagnostics</span><span class="op">(</span>CompilationStage<span class="op">.</span><span class="fu">Parse</span><span class="op">,</span> includeEarlierStages<span class="op">:</span> <span class="kw">false</span><span class="op">,</span> diagnostics<span class="op">,</span> cancellationToken<span class="op">);</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span><span class="fu">HasUnsuppressableErrors</span><span class="op">(</span>diagnostics<span class="op">))</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span><span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// [...]</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Right away, we notice the invocation of
<code>compilation.GetDiagnostics</code> with
<code>CompilationStage.Parse</code>. The invocation is followed by a
check <code>HasUnsuppressableErrors</code> to determine whether the
compilation stage complete successfully and should the compilation move
on to the next stage or stop. If you keep looking through the code of
<code>CompileAndEmit</code> you‚Äôll find more spots that perform a call
to <code>HasUnsuppressableErrors(diagnostics)</code> and based on the
result decide to stop or carry on with the compilation.</p>
<h1 id="parsing">Parsing</h1>
<p>It‚Äôs easy to get hung up on parsing theory as it‚Äôs a fascinating area
of computer science. But try and resist the temptation as it gets real
complex really fast. And the thing is, coding up a <strong>recursive
descent parser</strong> takes very little knowledge of the theory. Of
course, you can always come back later and study parsing in great
details. Actually, first getting a feel for it by doing is going to be a
great help in grasping the theory later.</p>
<p>Using a parser generator tool or a parser combinator library might
sounds like a good way to save time and effort vs writing a parser by
hand. But writing a hand-crafted parser might turn out easier than it
seems from the outset. Once you get into the groove, you may realize
that while it does take more typing, than using a tool wood, in return
you get straightforward handwritten code that is easy to reason about
and debug. And if you hit a special case, you just add a branch to
handle it instead of fighting with a tool which might or might not be
well documented.</p>
<p>Again, I cannot recommend <a
href="https://craftinginterpreters.com/contents.html">‚ÄúCrafting
Interpreters‚Äù</a> enough for a guide on implementing a parser.</p>
<p>It‚Äôs hard to underestimate the importance of having a working example
to look at and fully comprehend. Here goes a couple:</p>
<ul>
<li><a href="https://github.com/rui314/8cc">8cc C Compiler</a></li>
<li><a href="https://github.com/rui314/chibicc">chibicc: A Small C
Compiler</a></li>
<li><a href="https://github.com/TinyCC/tinycc">Tiny C Compiler</a></li>
<li><a href="https://github.com/drh/lcc">lcc</a></li>
</ul>
<p>Please, keep in mind, the last two are much bigger than
<code>8cc</code> and <code>chibicc</code> and don‚Äôt have easy of
exploring their sources as an explicit goal.</p>
<p>An impressive thing to note is production-grade, major-league
language implementations like <code>GCC</code>, <code>Clang</code>,
<code>Roslyn (C# and VB.NET compiler)</code>, <code>D</code>,
<code>Rust</code>, <code>Swift</code>, <code>Go</code>,
<code>Java</code>, <code>V8</code>, and <code>TypeScript</code> use
hand-crafted recursive descent parsers too. So, if you decide to go down
this route, your experience will actually be closer to that of
professional compiler developers :)</p>
<h1 id="emitting-assembly">Emitting assembly</h1>
<p>The compiler translates the source code down to x86-64 assembly. Then
GNU <code>as</code> and <code>ld</code> come into play to build a native
executable from the assembly.</p>
<p>Many educational compilers emit MIPS assembly, and although it‚Äôs
possible to run it using an emulator, to me, running a native executable
produced by your own compiler feels much more rewarding.</p>
<p>I also prefer emitting assembly instead of, for instance, C. It helps
understand the inner workings of various things we often take for
granted when coding in high-level languages:</p>
<ul>
<li>Managing a function‚Äôs stack frame</li>
<li>Calling conventions</li>
<li>Finding the memory address of an identifier</li>
<li>Converting expressions into assembly</li>
<li>And so on, and so forth</li>
</ul>
<p>On the other hand, someone enthusiastic about compilers isn‚Äôt
unlikely to be interested in going even deeper, down to the level of
binary machine code and linking. I decided to stop short of working on
these undeniably enticing subjects, to focus on building a working
compiler first.</p>
<p>All in all, assembly code native to your platform is a sweet spot for
translation. It gets you close-enough to the metal to learn how
high-level languages do their magic. But is abstract enough to avoid
getting distracted by somewhat orthogonal subjects.</p>
<p><a
href="https://www3.nd.edu/~dthain/compilerbook/chapter11.pdf">Chapter 11
‚Äì Code Generation</a> of <a
href="https://www3.nd.edu/~dthain/compilerbook/">Introduction to
Compilers and Language Design</a> is a great discussion of a basic
approach to assembly generation.</p>
<p>Examining the sources of <a
href="https://github.com/rui314/chibicc">chibicc: A Small C Compiler</a>
or <a href="https://github.com/rui314/8cc">8cc C Compiler</a> is an
excellent opportunity to see assembly-generating code in action.</p>
<h2 id="human-readable-assembly">Human-readable assembly</h2>
<p>The emitted assembly code contains a lot of hopefully useful
comments. The idea here is to help understand the assembly and relate it
back to the source code as much as possible.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>    .text</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    # ../CoolPrograms<span class="op">/</span>Runtime<span class="op">/</span>Fibonacci<span class="op">.</span>cool<span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">7</span><span class="op">):</span> Fib</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Fib..ctor:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    pushq   <span class="op">%</span><span class="kw">rbp</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">rsp</span><span class="op">,</span> <span class="op">%</span><span class="kw">rbp</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    subq    <span class="op">$</span><span class="bn">64</span><span class="op">,</span> <span class="op">%</span><span class="kw">rsp</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    # <span class="bu">store</span> actuals on the stack</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">rdi</span><span class="op">,</span> <span class="op">-</span><span class="dv">8</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    # <span class="bu">store</span> callee<span class="op">-</span>saved regs on the stack</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">rbx</span><span class="op">,</span> <span class="op">-</span><span class="dv">24</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">r12</span><span class="op">,</span> <span class="op">-</span><span class="dv">32</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">r13</span><span class="op">,</span> <span class="op">-</span><span class="dv">40</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">r14</span><span class="op">,</span> <span class="op">-</span><span class="dv">48</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">r15</span><span class="op">,</span> <span class="op">-</span><span class="dv">56</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    # actual <span class="op">#</span><span class="dv">0</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">-</span><span class="dv">8</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),</span> <span class="op">%</span><span class="kw">rbx</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    subq    <span class="op">$</span><span class="bn">8</span><span class="op">,</span> <span class="op">%</span><span class="kw">rsp</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">rbx</span><span class="op">,</span> <span class="dv">0</span><span class="op">(%</span><span class="kw">rsp</span><span class="op">)</span> <span class="op">#</span> actual <span class="op">#</span><span class="dv">0</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    # <span class="bu">load</span> up to <span class="dv">6</span> first actuals into regs</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="dv">0</span><span class="op">(%</span><span class="kw">rsp</span><span class="op">),</span> <span class="op">%</span><span class="kw">rdi</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    # remove the register<span class="op">-</span>loaded actuals from stack</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    addq    <span class="op">$</span><span class="bn">8</span><span class="op">,</span> <span class="op">%</span><span class="kw">rsp</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">call</span>    IO<span class="op">..</span>ctor <span class="op">#</span> super<span class="op">..</span>ctor</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">rax</span><span class="op">,</span> <span class="op">%</span><span class="kw">rbx</span> <span class="op">#</span> returned value</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    # ../CoolPrograms<span class="op">/</span>Runtime<span class="op">/</span>Fibonacci<span class="op">.</span>cool<span class="op">(</span><span class="dv">8</span><span class="op">,</span><span class="dv">5</span><span class="op">):</span> var i<span class="op">:</span> Int <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    # ../CoolPrograms<span class="op">/</span>Runtime<span class="op">/</span>Fibonacci<span class="op">.</span>cool<span class="op">(</span><span class="dv">8</span><span class="op">,</span><span class="dv">18</span><span class="op">):</span> <span class="dv">0</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">$</span>int_const_0<span class="op">,</span> <span class="op">%</span><span class="kw">rbx</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">rbx</span><span class="op">,</span> <span class="op">-</span><span class="dv">16</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span> <span class="op">#</span> i</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    # ../CoolPrograms<span class="op">/</span>Runtime<span class="op">/</span>Fibonacci<span class="op">.</span>cool<span class="op">(</span><span class="dv">9</span><span class="op">,</span><span class="dv">5</span><span class="op">):</span> while <span class="op">(</span>i <span class="op">&lt;=</span> <span class="dv">10</span><span class="op">)</span> <span class="op">{</span> <span class="op">\</span>n   <span class="op">...</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="fu">.label_6:</span> # <span class="pp">while</span> cond</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    # ../CoolPrograms<span class="op">/</span>Runtime<span class="op">/</span>Fibonacci<span class="op">.</span>cool<span class="op">(</span><span class="dv">9</span><span class="op">,</span><span class="dv">12</span><span class="op">):</span> i <span class="op">&lt;=</span> <span class="dv">10</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    # ../CoolPrograms<span class="op">/</span>Runtime<span class="op">/</span>Fibonacci<span class="op">.</span>cool<span class="op">(</span><span class="dv">9</span><span class="op">,</span><span class="dv">12</span><span class="op">):</span> i</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">-</span><span class="dv">16</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),</span> <span class="op">%</span><span class="kw">r10</span> <span class="op">#</span> i</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    # ../CoolPrograms<span class="op">/</span>Runtime<span class="op">/</span>Fibonacci<span class="op">.</span>cool<span class="op">(</span><span class="dv">9</span><span class="op">,</span><span class="dv">17</span><span class="op">):</span> <span class="dv">10</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">$</span>int_const_2<span class="op">,</span> <span class="op">%</span><span class="kw">r11</span></span></code></pre></div>
<h2 id="register-allocation">Register allocation</h2>
<p>In short, programs use processor registers to temporarily store
variable and expression values. This post won‚Äôt dig any deeper than
that, as by the time you get to implementing <a
href="https://en.wikipedia.org/wiki/Register_allocation">register
allocation</a>, you‚Äôll in all likelihood have read longer descriptions
by people who are actually good at explaining things.</p>
<p>Anyway, something to keep in mind, coding up register allocation can
be a rather involved exercise. Register allocation in production
compilers is <a
href="http://www.rw.cdl.uni-saarland.de/~grund/papers/cc06-ra_ssa.pdf">a
matter</a> <a
href="https://www.info.uni-karlsruhe.de/uploads/publikationen/braun13cc.pdf">of
scientific</a> <a
href="http://web.cs.ucla.edu/~palsberg/course/cs232/papers/HackGoos-ipl06.pdf">research</a>.
But there‚Äôs an extremely simple approach that is great to get a compiler
up and running and can get it surprisingly far. It‚Äôs laid out in that
same ‚ÄúChapter 11 ‚Äì Code Generation‚Äù:</p>
<blockquote>
<p>[Y]ou can see that we set aside each register for a purpose: some are
for function arguments, some for stack frame management, and some are
available for scratch values. Take those scratch registers and put them
into a table [‚Ä¶] Then, write <code>scratch_alloc</code> to find an
unused register in the table, mark it as in use, and return the register
number <code>r</code>. <code>scratch_free</code> should mark the
indicated register as available. <code>scratch_name</code> should return
the name of a register, given its number <code>r</code>. Running out of
scratch registers is possible, but unlikely, as we will see below. For
now, if <code>scratch_alloc</code> cannot find a free register, just
emit an error message and halt.</p>
<p>‚Äî <cite><a
href="https://www3.nd.edu/~dthain/compilerbook/chapter11.pdf">11.2
Supporting Functions</a></cite></p>
</blockquote>
<h1 id="runtime-library">Runtime library</h1>
<p>An implementation of educational language relies on a number of
built-in functions, classes, and objects. Some of these are available to
the user directly, such as ChocoPy‚Äôs <code>print</code> function or Cool
2020‚Äôs <code>IO</code> class. References to other built-ins can only be
injected into a program by the compiler ‚Äî for example, to allocate the
memory for a new object or abort the execution in case things have gone
off the rails.</p>
<p>The only readily available <a
href="https://theory.stanford.edu/~aiken/software/cooldist/lib/trap.handler">runtime
implementation</a> for an educational language I‚Äôm aware of is written
in MIPS assembly for the language <a
href="https://theory.stanford.edu/~aiken/software/cool/cool.html">COOL</a>
designed by <a href="https://profiles.stanford.edu/alex-aiken">Alex
Aiken</a> used in his famous <a
href="https://online.stanford.edu/courses/soe-ycscs1-compilers">online
course</a>.</p>
<p>(Notice, while the names Cool 2020 and COOL sound confusingly
similar, the languages themselves are distinct: Cool 2020 is a Scala
subset and COOL is an invention of Alex Aiken. The name Cool 2020 is a
tribute to Aiken‚Äôs COOL.)</p>
<p>Examining COOL runtime‚Äôs MIPS code provides enough insights to
implement a similar one for a different ‚Äúclient‚Äù language and dialect of
assembly. This is how I came up with a <a
href="https://github.com/mykolav/coollang-2020-fs/tree/master/src/Runtime">runtime</a>
for Cool 2020 in x86-64 assembly. It‚Äôs written in an extremely naive and
unoptimized way, but gets the job done. One serious omission though,
there‚Äôs no garbage collection code (One day‚Ä¶)</p>
<h2 id="runtime-library-source-code-structure">Runtime library source
code structure</h2>
<p>The runtime is made up of three assembly source files:</p>
<ul>
<li><a
href="https://github.com/mykolav/coollang-2020-fs/blob/6174d03148e7e395d1e5777c370000bf47e1578f/src/Runtime/rt_common.s">rt_common.s</a>
‚Äî the common code that doesn‚Äôt depend on a platform‚Äôs specifics resides
in this file</li>
<li><a
href="https://github.com/mykolav/coollang-2020-fs/blob/6174d03148e7e395d1e5777c370000bf47e1578f/src/Runtime/rt_linux.s">rt_linux.s</a>
‚Äî Linux-specific bits</li>
<li><a
href="https://github.com/mykolav/coollang-2020-fs/blob/6174d03148e7e395d1e5777c370000bf47e1578f/src/Runtime/rt_windows.s">rt_windows.s</a>
‚Äî Windows-specific bits</li>
</ul>
<h2 id="the-entry-point">The entry point</h2>
<p>In particular, <code>rt_common.s</code> contains a compiled program‚Äôs
process entry point responsible for</p>
<ul>
<li>Invoking the platform-dependent initialization routine</li>
<li>Allocating memory for an instance of the class <code>Main</code> and
invoking its constructor.</li>
<li>Exiting the process once the user‚Äôs code have finished
executing</li>
</ul>
<p>The process entry point‚Äôs logic expressed in pseudocode follows.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode scala"><code class="sourceCode scala"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a> <span class="kw">def</span> <span class="fu">main</span> <span class="op">()</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a> <span class="op">.</span> Platform <span class="op">.</span><span class="fu">init</span><span class="op">();</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">new</span> <span class="fu">Main</span><span class="op">();</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a> <span class="op">.</span>Platform<span class="op">.</span><span class="fu">exit_process</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And here is the actual assembly code.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>    .global main</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">main:</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">call</span>    <span class="op">.</span>Platform<span class="op">.</span>init</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    # A class <span class="st">&#39;Main&#39;</span> must be present in every Cool2020 program<span class="op">.</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    # Create a new instance of <span class="st">&#39;Main&#39;</span><span class="op">.</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">$</span>Main_proto_obj<span class="op">,</span> <span class="op">%</span><span class="kw">rdi</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">call</span>    <span class="op">.</span>Runtime<span class="op">.</span>copy_object</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    # &#39;Main<span class="op">..</span>ctor<span class="st">&#39; is a Cool2020 program&#39;</span>s entry point<span class="op">.</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    # Pass a reference to the newly created <span class="st">&#39;Main&#39;</span> instance in <span class="op">%</span><span class="kw">rdi</span><span class="op">.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    # <span class="bu">Invoke</span> the constructor<span class="op">.</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>    <span class="op">%</span><span class="kw">rax</span><span class="op">,</span> <span class="op">%</span><span class="kw">rdi</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">call</span>    Main<span class="op">..</span>ctor</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    xorq    <span class="op">%</span><span class="kw">rdi</span><span class="op">,</span> <span class="op">%</span><span class="kw">rdi</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">jmp</span>     <span class="op">.</span>Platform<span class="op">.</span>exit_process</span></code></pre></div>
<h1 id="learning-resources">Learning resources</h1>
<h2 id="crafting-interpreters">Crafting Interpreters</h2>
<p>Yes, yes, you read that right, interpreters. <a
href="https://craftinginterpreters.com/contents.html">Crafting
Interpreters</a> by Robert Nystrom is simply a brilliant book, which
despite its name can serve as a great introduction to compilers.
Compilers and interpreters have a lot in common and by the time you get
to the interpreters-specific topics, you‚Äôll gain a ton of useful
knowledge. In my opinion, the explanations on general programming
language implementation concepts, lexing, and parsing are downright the
best in class.</p>
<h2 id="introduction-to-compilers-and-language-design">Introduction to
Compilers and Language Design</h2>
<p><a href="https://www3.nd.edu/~dthain/compilerbook/">Introduction to
Compilers and Language Design</a> by Douglas Thain is really accessible
and doesn‚Äôt assume any preexisting compilers knowledge. It teaches all
the basics necessary to build a compiler: from lexing and parsing to a
program‚Äôs memory organization and stack management to assembly
generation. It‚Äôs self-contained and takes a hands-on approach: you‚Äôll
end up with a working compiler if you choose to following the book
through. If later you feel like digging into more advanced compiling
techniques, you‚Äôll have a solid foundation to build upon.</p>
<p>Both are freely available online. (I encourage you to consider buying
the paid versions of the books though, if you can, to support the
authors).</p>
<h2 id="building-a-compiler-video-series-by-immo-landwerth">Building a
Compiler video series by Immo Landwerth</h2>
<p>Who‚Äôs gonna watch a Fortnite stream on Twitch, when Immo Landwerth is
<a
href="https://www.youtube.com/watch?v=wgHIkdUQbp0&amp;list=PLRAdsfhKI4OWNOSfS7EUu5GRAVmze1t2y">coding
up a compiler</a> live on YouTube?! Apart from all the usual compiling
topics, the series touch upon adding a basic debugger support, so that
it‚Äôs possible to step through the source of a compiled program. Immo is
an awesome educator and their code is accessible and simply beautiful.
You can explore it in <a href="https://github.com/terrajobst/minsk">the
project‚Äôs github repo</a>.</p>
<h2 id="cs-6120-advanced-compilers-the-self-guided-online-course">CS
6120: Advanced Compilers: The Self-Guided Online Course</h2>
<p>A free self-guided online course from Cornell University. Goes in
depth on IR and optimizations but is very accessible at the same time.
Again, cannot recommend highly enough. <a
href="https://www.cs.cornell.edu/courses/cs6120/2020fa/self-guided/">CS
6120: Advanced Compilers: The Self-Guided Online Course</a>.</p>
<h2 id="llvm-ir-tutorial---phis-geps">LLVM IR Tutorial - Phis, GEPs
‚Ä¶</h2>
<p>A talk on intermediate representations (IR). Previous knowledge is
not required. What‚Äôs so cool about this talk is it‚Äôs built around one of
the most widely used IR ‚Äî LLVM IR. <a
href="https://www.youtube.com/watch?v=m8G_S5LwlTo">2019 EuroLLVM
Developers‚Äô Meeting: V. Bridgers &amp; F. Piovezan ‚ÄúLLVM IR Tutorial -
Phis, GEPs ‚Ä¶‚Äù</a>.</p>
<h1 id="looking-to-implement-a-compiler-yourself">Looking to implement a
compiler yourself?</h1>
<h2 id="do-not-start-with-classics-textbooks">Do not start with classics
textbooks</h2>
<p>While there‚Äôs no way around studying a bit of theory before getting
down to coding, <strong>do not</strong> start with classics textbooks
like the Dragon Book, or ‚ÄúModern Compiler Implementation‚Äù. These are
great, and you can always come back to them later, when you‚Äôre better
prepared to take the most out of them.</p>
<p>That said, it‚Äôs way more productive to read ones geared toward
beginners first. The ones I‚Äôd opt for are listed in the <a
href="#learning-resources">Learning resources</a> section.</p>
<h2 id="dont-try-to-come-up-with-your-own-language-just-yet">Don‚Äôt try
to come up with your own language just yet</h2>
<p>Go with an existing educational language instead, and focus on
learning about compilers.</p>
<h2 id="stay-focused">Stay focused</h2>
<p>Compiling is a huge field. You‚Äôll encounter seemingly endless
choices, techniques, and opinions each step of the way. At times it‚Äôs
hard not to give in to the temptation of going down the rabbit hole of
researching all kind of ways of implementing a compilation stage or
algorithm. I believe keeping the project‚Äôs scope as narrow as possible
is a recipe for actually getting through to a working compiler.</p>
<p>Stick to straightforward simple ways of doing things at first.
Consider writing down all the interesting links and nuggets of
information you come across and setting them aside for a time. Once you
finally make it to the other side, you can start going through your
notes and replacing portions of the code with more advanced algorithms
or extending it with additional functionality.</p>
<p>Good luck!</p>
</body>
</html>
