<html lang="en">

<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <style>
        @import url('https://themes.googleusercontent.com/fonts/css?kit=cGvuclDC_Z1vE_cnVEU6AT_gOQZkhM0SBTdk8N4v3T_HUEn3hHzgUzs9hFMYxlVuiykyHc7-HDPI3oJL4o1Froem5VZo_4YcU9nO3fnnnyo');

        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out;
        }

        @keyframes octocat-wave {
            0% {
                transform: rotate(0deg);
            }

            20% {
                transform: rotate(-25deg);
            }

            40% {
                transform: rotate(10deg);
            }

            60% {
                transform: rotate(-25deg);
            }

            80% {
                transform: rotate(10deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        @media (max-width: 500px) {
            .github-corner:hover .octo-arm {
                animation: none;
            }

            .github-corner .octo-arm {
                animation: octocat-wave 560ms ease-in-out;
            }
        }

        ul.lst-kix_8bft9l9kqfrx-0 {
            list-style-type: none
        }

        ul.lst-kix_8bft9l9kqfrx-4 {
            list-style-type: none
        }

        ul.lst-kix_8bft9l9kqfrx-3 {
            list-style-type: none
        }

        .lst-kix_6dtc33tnykn6-8 > li:before {
            content: "\0025a0  "
        }

        ul.lst-kix_8bft9l9kqfrx-2 {
            list-style-type: none
        }

        ul.lst-kix_8bft9l9kqfrx-1 {
            list-style-type: none
        }

        ul.lst-kix_8bft9l9kqfrx-8 {
            list-style-type: none
        }

        ul.lst-kix_8bft9l9kqfrx-7 {
            list-style-type: none
        }

        ul.lst-kix_8bft9l9kqfrx-6 {
            list-style-type: none
        }

        ul.lst-kix_8bft9l9kqfrx-5 {
            list-style-type: none
        }

        .lst-kix_13xp18aibby-6 > li:before {
            content: "-  "
        }

        .lst-kix_13xp18aibby-7 > li:before {
            content: "-  "
        }

        .lst-kix_13xp18aibby-8 > li:before {
            content: "-  "
        }

        .lst-kix_9jcplmm8xy6l-4 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_9jcplmm8xy6l-5 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_9jcplmm8xy6l-3 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_9jcplmm8xy6l-7 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_13xp18aibby-5 > li:before {
            content: "-  "
        }

        .lst-kix_13xp18aibby-3 > li:before {
            content: "-  "
        }

        .lst-kix_13xp18aibby-4 > li:before {
            content: "-  "
        }

        .lst-kix_9jcplmm8xy6l-6 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_13xp18aibby-1 > li:before {
            content: "-  "
        }

        .lst-kix_13xp18aibby-2 > li:before {
            content: "-  "
        }

        ul.lst-kix_oc0tsm47xpne-7 {
            list-style-type: none
        }

        ul.lst-kix_oc0tsm47xpne-8 {
            list-style-type: none
        }

        ul.lst-kix_oc0tsm47xpne-5 {
            list-style-type: none
        }

        ul.lst-kix_oc0tsm47xpne-6 {
            list-style-type: none
        }

        ul.lst-kix_oc0tsm47xpne-3 {
            list-style-type: none
        }

        .lst-kix_9jcplmm8xy6l-0 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_9jcplmm8xy6l-1 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_oc0tsm47xpne-4 {
            list-style-type: none
        }

        ul.lst-kix_oc0tsm47xpne-1 {
            list-style-type: none
        }

        ul.lst-kix_oc0tsm47xpne-2 {
            list-style-type: none
        }

        .lst-kix_13xp18aibby-0 > li:before {
            content: "-  "
        }

        .lst-kix_9jcplmm8xy6l-2 > li:before {
            content: "\0025a0  "
        }

        ul.lst-kix_oc0tsm47xpne-0 {
            list-style-type: none
        }

        ul.lst-kix_6dtc33tnykn6-1 {
            list-style-type: none
        }

        ul.lst-kix_6dtc33tnykn6-0 {
            list-style-type: none
        }

        ul.lst-kix_6dtc33tnykn6-3 {
            list-style-type: none
        }

        ul.lst-kix_6dtc33tnykn6-2 {
            list-style-type: none
        }

        ul.lst-kix_6dtc33tnykn6-5 {
            list-style-type: none
        }

        ul.lst-kix_6dtc33tnykn6-4 {
            list-style-type: none
        }

        ul.lst-kix_6dtc33tnykn6-7 {
            list-style-type: none
        }

        ul.lst-kix_6dtc33tnykn6-6 {
            list-style-type: none
        }

        ul.lst-kix_6dtc33tnykn6-8 {
            list-style-type: none
        }

        .lst-kix_s5diz5hm61e3-0 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_s5diz5hm61e3-1 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_s5diz5hm61e3-2 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_s5diz5hm61e3-3 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_s5diz5hm61e3-5 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_9jcplmm8xy6l-8 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_s5diz5hm61e3-4 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_s5diz5hm61e3-7 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_s5diz5hm61e3-6 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_s5diz5hm61e3-8 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_oc0tsm47xpne-5 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_oc0tsm47xpne-3 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_oc0tsm47xpne-7 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_s5diz5hm61e3-0 {
            list-style-type: none
        }

        .lst-kix_8bft9l9kqfrx-7 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_ivj9gkbkx2b4-1 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_s5diz5hm61e3-8 {
            list-style-type: none
        }

        ul.lst-kix_s5diz5hm61e3-7 {
            list-style-type: none
        }

        ul.lst-kix_s5diz5hm61e3-6 {
            list-style-type: none
        }

        ul.lst-kix_s5diz5hm61e3-5 {
            list-style-type: none
        }

        ul.lst-kix_s5diz5hm61e3-4 {
            list-style-type: none
        }

        .lst-kix_ivj9gkbkx2b4-3 > li:before {
            content: "\0025cf  "
        }

        ul.lst-kix_s5diz5hm61e3-3 {
            list-style-type: none
        }

        ul.lst-kix_s5diz5hm61e3-2 {
            list-style-type: none
        }

        ul.lst-kix_s5diz5hm61e3-1 {
            list-style-type: none
        }

        .lst-kix_oc0tsm47xpne-1 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_v286z3ghxlg6-8 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_v286z3ghxlg6-6 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_8bft9l9kqfrx-5 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_8bft9l9kqfrx-1 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_8bft9l9kqfrx-3 > li:before {
            content: "\0025cf  "
        }

        ul.lst-kix_v286z3ghxlg6-0 {
            list-style-type: none
        }

        ul.lst-kix_v286z3ghxlg6-1 {
            list-style-type: none
        }

        .lst-kix_3hi1kckz9g8d-7 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_cmc84ktutgku-8 {
            list-style-type: none
        }

        ul.lst-kix_cmc84ktutgku-7 {
            list-style-type: none
        }

        ul.lst-kix_cmc84ktutgku-6 {
            list-style-type: none
        }

        ul.lst-kix_cmc84ktutgku-5 {
            list-style-type: none
        }

        ul.lst-kix_v286z3ghxlg6-8 {
            list-style-type: none
        }

        ul.lst-kix_cmc84ktutgku-4 {
            list-style-type: none
        }

        ul.lst-kix_cmc84ktutgku-3 {
            list-style-type: none
        }

        ul.lst-kix_v286z3ghxlg6-6 {
            list-style-type: none
        }

        ul.lst-kix_cmc84ktutgku-2 {
            list-style-type: none
        }

        ul.lst-kix_v286z3ghxlg6-7 {
            list-style-type: none
        }

        ul.lst-kix_cmc84ktutgku-1 {
            list-style-type: none
        }

        ul.lst-kix_v286z3ghxlg6-4 {
            list-style-type: none
        }

        ul.lst-kix_cmc84ktutgku-0 {
            list-style-type: none
        }

        ul.lst-kix_v286z3ghxlg6-5 {
            list-style-type: none
        }

        .lst-kix_3hi1kckz9g8d-1 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_v286z3ghxlg6-2 {
            list-style-type: none
        }

        ul.lst-kix_v286z3ghxlg6-3 {
            list-style-type: none
        }

        .lst-kix_v286z3ghxlg6-2 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_v286z3ghxlg6-0 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_v286z3ghxlg6-4 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_3hi1kckz9g8d-3 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_3hi1kckz9g8d-5 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_ivj9gkbkx2b4-7 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_6dtc33tnykn6-1 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_ivj9gkbkx2b4-5 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_6dtc33tnykn6-5 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_6dtc33tnykn6-3 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_6dtc33tnykn6-7 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_ivj9gkbkx2b4-8 {
            list-style-type: none
        }

        ul.lst-kix_ivj9gkbkx2b4-7 {
            list-style-type: none
        }

        ul.lst-kix_ivj9gkbkx2b4-6 {
            list-style-type: none
        }

        ul.lst-kix_ivj9gkbkx2b4-5 {
            list-style-type: none
        }

        ul.lst-kix_ivj9gkbkx2b4-4 {
            list-style-type: none
        }

        ul.lst-kix_ivj9gkbkx2b4-3 {
            list-style-type: none
        }

        ul.lst-kix_ivj9gkbkx2b4-2 {
            list-style-type: none
        }

        ul.lst-kix_ivj9gkbkx2b4-1 {
            list-style-type: none
        }

        ul.lst-kix_ivj9gkbkx2b4-0 {
            list-style-type: none
        }

        ul.lst-kix_9jcplmm8xy6l-8 {
            list-style-type: none
        }

        .lst-kix_5vfkf5du9p9h-7 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_5vfkf5du9p9h-8 > li:before {
            content: "\0025a0  "
        }

        ul.lst-kix_9jcplmm8xy6l-0 {
            list-style-type: none
        }

        ul.lst-kix_3hi1kckz9g8d-2 {
            list-style-type: none
        }

        ul.lst-kix_9jcplmm8xy6l-1 {
            list-style-type: none
        }

        ul.lst-kix_3hi1kckz9g8d-1 {
            list-style-type: none
        }

        ul.lst-kix_9jcplmm8xy6l-2 {
            list-style-type: none
        }

        .lst-kix_5vfkf5du9p9h-3 > li:before {
            content: "\0025cf  "
        }

        ul.lst-kix_3hi1kckz9g8d-0 {
            list-style-type: none
        }

        .lst-kix_cmc84ktutgku-7 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_9jcplmm8xy6l-3 {
            list-style-type: none
        }

        ul.lst-kix_9jcplmm8xy6l-4 {
            list-style-type: none
        }

        .lst-kix_5vfkf5du9p9h-2 > li:before {
            content: "\0025a0  "
        }

        ul.lst-kix_9jcplmm8xy6l-5 {
            list-style-type: none
        }

        ul.lst-kix_9jcplmm8xy6l-6 {
            list-style-type: none
        }

        .lst-kix_cmc84ktutgku-8 > li:before {
            content: "\0025a0  "
        }

        ul.lst-kix_9jcplmm8xy6l-7 {
            list-style-type: none
        }

        .lst-kix_5vfkf5du9p9h-0 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_5vfkf5du9p9h-1 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_cmc84ktutgku-1 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_cmc84ktutgku-0 > li:before {
            content: "\0025cf  "
        }

        ul.lst-kix_3hi1kckz9g8d-8 {
            list-style-type: none
        }

        .lst-kix_cmc84ktutgku-3 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_cmc84ktutgku-5 > li:before {
            content: "\0025a0  "
        }

        ul.lst-kix_3hi1kckz9g8d-7 {
            list-style-type: none
        }

        ul.lst-kix_3hi1kckz9g8d-6 {
            list-style-type: none
        }

        ul.lst-kix_3hi1kckz9g8d-5 {
            list-style-type: none
        }

        ul.lst-kix_3hi1kckz9g8d-4 {
            list-style-type: none
        }

        .lst-kix_cmc84ktutgku-2 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_cmc84ktutgku-6 > li:before {
            content: "\0025cf  "
        }

        ul.lst-kix_3hi1kckz9g8d-3 {
            list-style-type: none
        }

        .lst-kix_5vfkf5du9p9h-4 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_5vfkf5du9p9h-5 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_5vfkf5du9p9h-6 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_cmc84ktutgku-4 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_13xp18aibby-7 {
            list-style-type: none
        }

        ul.lst-kix_13xp18aibby-8 {
            list-style-type: none
        }

        ul.lst-kix_13xp18aibby-5 {
            list-style-type: none
        }

        ul.lst-kix_13xp18aibby-6 {
            list-style-type: none
        }

        ul.lst-kix_13xp18aibby-3 {
            list-style-type: none
        }

        ul.lst-kix_13xp18aibby-4 {
            list-style-type: none
        }

        ul.lst-kix_13xp18aibby-1 {
            list-style-type: none
        }

        .lst-kix_oc0tsm47xpne-6 > li:before {
            content: "\0025cf  "
        }

        ul.lst-kix_13xp18aibby-2 {
            list-style-type: none
        }

        ul.lst-kix_13xp18aibby-0 {
            list-style-type: none
        }

        .lst-kix_oc0tsm47xpne-4 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_8bft9l9kqfrx-8 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_ivj9gkbkx2b4-0 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_oc0tsm47xpne-2 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_ivj9gkbkx2b4-2 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_oc0tsm47xpne-0 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_8bft9l9kqfrx-0 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_v286z3ghxlg6-7 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_v286z3ghxlg6-5 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_8bft9l9kqfrx-6 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_8bft9l9kqfrx-4 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_8bft9l9kqfrx-2 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_oc0tsm47xpne-8 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_3hi1kckz9g8d-8 > li:before {
            content: "\0025a0  "
        }

        ul.lst-kix_5vfkf5du9p9h-6 {
            list-style-type: none
        }

        ul.lst-kix_5vfkf5du9p9h-5 {
            list-style-type: none
        }

        .lst-kix_3hi1kckz9g8d-6 > li:before {
            content: "\0025cf  "
        }

        ul.lst-kix_5vfkf5du9p9h-8 {
            list-style-type: none
        }

        ul.lst-kix_5vfkf5du9p9h-7 {
            list-style-type: none
        }

        .lst-kix_3hi1kckz9g8d-2 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_v286z3ghxlg6-3 > li:before {
            content: "\0025cf  "
        }

        ul.lst-kix_5vfkf5du9p9h-2 {
            list-style-type: none
        }

        ul.lst-kix_5vfkf5du9p9h-1 {
            list-style-type: none
        }

        .lst-kix_3hi1kckz9g8d-4 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_5vfkf5du9p9h-4 {
            list-style-type: none
        }

        ul.lst-kix_5vfkf5du9p9h-3 {
            list-style-type: none
        }

        .lst-kix_v286z3ghxlg6-1 > li:before {
            content: "\0025cb  "
        }

        ul.lst-kix_5vfkf5du9p9h-0 {
            list-style-type: none
        }

        .lst-kix_ivj9gkbkx2b4-8 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_6dtc33tnykn6-0 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_ivj9gkbkx2b4-4 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_ivj9gkbkx2b4-6 > li:before {
            content: "\0025cf  "
        }

        li.li-bullet-0:before {
            margin-left: -18pt;
            white-space: nowrap;
            display: inline-block;
            min-width: 18pt
        }

        .lst-kix_6dtc33tnykn6-2 > li:before {
            content: "\0025a0  "
        }

        .lst-kix_3hi1kckz9g8d-0 > li:before {
            content: "\0025cf  "
        }

        .lst-kix_6dtc33tnykn6-4 > li:before {
            content: "\0025cb  "
        }

        .lst-kix_6dtc33tnykn6-6 > li:before {
            content: "\0025cf  "
        }

        ol {
            margin: 0;
            padding: 0
        }

        table td,
        table th {
            padding: 0
        }

        .c20 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            background-color: #f8f8f8;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 144pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c43 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            background-color: #f8f8f8;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 324pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c22 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            background-color: #f8f8f8;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 468pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c41 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            background-color: #f8f8f8;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 234pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c45 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 234pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c33 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 375pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c28 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 175.5pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c39 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 292.5pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c40 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 93pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c58 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 324pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c54 {
            border-right-style: solid;
            padding: 5pt 5pt 5pt 5pt;
            border-bottom-color: #000000;
            border-top-width: 0pt;
            border-right-width: 0pt;
            border-left-color: #000000;
            vertical-align: top;
            border-right-color: #000000;
            border-left-width: 0pt;
            border-top-style: solid;
            border-left-style: solid;
            border-bottom-width: 0pt;
            width: 144pt;
            border-top-color: #000000;
            border-bottom-style: solid
        }

        .c26 {
            margin-left: -0.8pt;
            padding-top: 24pt;
            padding-bottom: 0pt;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left;
            margin-right: 89.2pt
        }

        .c8 {
            color: #000000;
            font-weight: 700;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 11pt;
            font-family: sans-serif;
            font-style: normal
        }

        .c19 {
            color: #000000;
            font-weight: 700;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 13pt;
            font-family: sans-serif;
            font-style: normal
        }

        .c23 {
            margin-left: -0.8pt;
            padding-top: 0pt;
            padding-bottom: 0pt;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c31 {
            margin-left: -0.8pt;
            padding-top: 3pt;
            padding-bottom: 0pt;
            line-height: 1.5;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c5 {
            margin-left: -0.8pt;
            padding-top: 10pt;
            padding-bottom: 0pt;
            line-height: 1.5;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c1 {
            color: #000000;
            font-weight: 700;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 16pt;
            font-family: sans-serif;
            font-style: normal
        }

        .c42 {
            color: #000000;
            font-weight: 400;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 12pt;
            font-family: sans-serif;
            font-style: normal
        }

        .c64 {
            margin-left: -0.8pt;
            padding-top: 6pt;
            padding-bottom: 0pt;
            line-height: 1.5;
            orphans: 2;
            widows: 2;
            text-align: center
        }

        .c55 {
            margin-left: 18pt;
            padding-top: 3pt;
            padding-bottom: 4pt;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c30 {
            margin-left: 18pt;
            padding-top: 3pt;
            padding-bottom: 0pt;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c44 {
            margin-left: -0.8pt;
            padding-top: 30pt;
            padding-bottom: 0pt;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c0 {
            color: #000000;
            font-weight: 400;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 11pt;
            font-family: sans-serif;
            font-style: normal
        }

        .c53 {
            padding-top: 24pt;
            padding-bottom: 0pt;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left;
            margin-right: 89.2pt
        }

        .c27 {
            padding-top: 0pt;
            padding-bottom: 0pt;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c59 {
            color: #999999;
            font-weight: 400;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 14pt;
            font-family: sans-serif
        }

        .c62 {
            padding-top: 4pt;
            padding-bottom: 0pt;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c49 {
            color: #000000;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 30pt;
            font-family: sans-serif;
            font-style: normal
        }

        .c14 {
            padding-top: 10pt;
            padding-bottom: 0pt;
            line-height: 1.5;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c18 {
            padding-top: 10pt;
            padding-bottom: 0pt;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c3 {
            background-color: #f8f8f8;
            font-family: monospace;
            color: #333333;
            font-weight: 700
        }

        .c37 {
            border-spacing: 0;
            border-collapse: collapse;
            margin-right: auto
        }

        .c9 {
            background-color: #f8f8f8;
            font-family: monospace;
            color: #445588;
            font-weight: 700
        }

        .c2 {
            background-color: #f8f8f8;
            font-family: monospace;
            color: #333333;
            font-weight: 400
        }

        .c25 {
            background-color: #f8f8f8;
            font-family: monospace;
            color: #990000;
            font-weight: 700
        }

        .c12 {
            text-decoration-skip-ink: none;
            -webkit-text-decoration-skip: none;
            color: #1155cc;
            text-decoration: underline
        }

        .c57 {
            color: #000000;
            font-weight: 400;
            text-decoration: none;
            vertical-align: baseline
        }

        .c16 {
            background-color: #f8f8f8;
            font-family: monospace;
            color: #dd1144;
            font-weight: 700
        }

        .c10 {
            padding-top: 0pt;
            padding-bottom: 0pt;
            line-height: 1.15;
            text-align: left
        }

        .c7 {
            background-color: #f8f8f8;
            font-style: italic;
            color: #999988
        }

        .c24 {
            text-decoration: none;
            vertical-align: baseline;
            font-size: 11pt
        }

        .c46 {
            background-color: #f8f8f8;
            font-family: monospace;
            color: #999999
        }

        .c15 {
            margin-left: 72pt;
            padding-left: 0pt;
            margin-right: 36pt
        }

        .c32 {
            margin-left: 35.2pt;
            margin-right: 36pt
        }

        .c34 {
            background-color: #f8f8f8;
            color: #990073
        }

        .c38 {
            padding: 0;
            margin: 0
        }

        .c29 {
            background-color: #f8f8f8;
            color: #dd1144
        }

        .c4 {
            font-weight: 400;
            font-family: monospace
        }

        .c21 {
            margin-left: 36pt;
            padding-left: 0pt
        }

        .c11 {
            color: inherit;
            text-decoration: inherit
        }

        .c13 {
            background-color: #f8f8f8;
            color: #008080
        }

        .c63 {
            max-width: 468pt;
            padding: 72pt 72pt 72pt 72pt
        }

        .c61 {
            margin-left: 36pt;
            margin-right: 36pt
        }

        .c36 {
            font-weight: 700
        }

        .c52 {
            height: 16pt
        }

        .c60 {
            text-indent: 0.8pt
        }

        .c48 {
            background-color: #ffffff
        }

        .c51 {
            font-family: monospace
        }

        .c47 {
            background-color: #f8f8f8
        }

        .c6 {
            height: 0pt
        }

        .c50 {
            font-style: normal
        }

        .c17 {
            font-size: 9pt
        }

        .c56 {
            font-family: sans-serif
        }

        .c35 {
            height: 11pt
        }

        .title {
            padding-top: 0pt;
            color: #000000;
            font-size: 30pt;
            padding-bottom: 0pt;
            font-family: sans-serif;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .subtitle {
            padding-top: 0pt;
            color: #999999;
            font-size: 14pt;
            padding-bottom: 0pt;
            font-family: sans-serif;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        li {
            color: #000000;
            font-size: 11pt;
            font-family: sans-serif
        }

        p {
            margin: 0;
            color: #000000;
            font-size: 11pt;
            font-family: sans-serif
        }

        h1 {
            padding-top: 10pt;
            color: #000000;
            font-weight: 700;
            font-size: 16pt;
            padding-bottom: 0pt;
            font-family: sans-serif;
            line-height: 1.5;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h2 {
            padding-top: 24pt;
            color: #000000;
            font-weight: 700;
            font-size: 13pt;
            padding-bottom: 0pt;
            font-family: sans-serif;
            line-height: 1.0;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h3 {
            padding-top: 10pt;
            color: #000000;
            font-weight: 700;
            font-size: 12pt;
            padding-bottom: 0pt;
            font-family: sans-serif;
            line-height: 1.5;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h4 {
            padding-top: 8pt;
            -webkit-text-decoration-skip: none;
            color: #666666;
            text-decoration: underline;
            font-size: 11pt;
            padding-bottom: 0pt;
            line-height: 1.5;
            page-break-after: avoid;
            text-decoration-skip-ink: none;
            font-family: "Trebuchet MS";
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h5 {
            padding-top: 8pt;
            color: #666666;
            font-size: 11pt;
            padding-bottom: 0pt;
            font-family: "Trebuchet MS";
            line-height: 1.5;
            page-break-after: avoid;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h6 {
            padding-top: 8pt;
            color: #666666;
            font-size: 11pt;
            padding-bottom: 0pt;
            font-family: "Trebuchet MS";
            line-height: 1.5;
            page-break-after: avoid;
            font-style: italic;
            orphans: 2;
            widows: 2;
            text-align: left
        }
    </style>
    <title>A toy compiler of a Scala subset</title>
</head>

<body class="c48 c63">
    <p class="c27 c60 title" id="h.mbjsiz6n6jlo"><span class="c36 c56">A toy compiler of a Scala subset</span></p>
    <p class="c31">
        <span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 4.00px;">
            <img alt="" src="images/horizontal-line.png"
                 style="width: 624.00px; height: 4.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);"
                 title="horizontal line">
        </span>
    </p>
    <p class="c31"><span class="c0">I got curious about the inner workings of compilers a long time ago.</span></p>
    <p class="c31">
        <span>But only recently had</span><span class="c0">
            &nbsp;a chance to devote more time and effort to
            the topic. As a result, I finally wrote a compiler.
        </span>
    </p>
    <p class="c31">
        <span class="c0">
            Why write another toy compiler? Honestly, in terms of education or interesting ideas
            it hardly has anything to offer over existing mini compilers. Still, a few things should set this one apart.
        </span>
    </p>
    <p class="c31">
        <span class="c0">
            For starters, the language. Many toy/teaching languages pretty much have only
            functions and simple values. They seem too primitive to me. Our language&rsquo;s name is Cool 2020,
            it&rsquo;s a Scala subset. Cool 2020 is concise and easy to implement but retains many features of grown-up
            programming languages: static typing, classes, dynamic dispatch, and even the simplest form of pattern
            matching.
        </span>
    </p>
    <p class="c31">
        <span class="c0">
            Then there is a question: what flavour of assembly language the compiler should
            emit? Compiler courses usually pick MIPS assembly for generation and run it using an emulator. They surely
            have good reasons for doing this, but to me being able to run the emitted assembly as a native OS executable
            feels infinitely more satisfying. So, we&rsquo;re going to emit x86-64 assembly for Windows and
            Linux.
        </span>
    </p>
    <p class="c31">
        <span>Go to <span class="c12"><a class="c11" href="https://github.com/mykolav/coollang-2020-fs">the project's repository</a></span> to explore the source code.</span>
    </p>
    <h1 class="c64" id="h.vydniszftb1n">
        <span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 435.50px; height: 435.50px;">
            <img alt="Complexity of toy compiler design" src="images/complexity-of-toy-compiler-design.png"
                 style="width: 435.50px; height: 435.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);"
                 title="">
        </span>
    </h1>
    <h1 class="c5 c52" id="h.7474cuc8tt96"><span class="c1"></span></h1>
    <p class="c62"><span class="c8"><a class="c11" href="#h.10ihxg5fxz2w">This is not a tutorial</a></span></p>
    <p class="c18"><span class="c8"><a class="c11" href="#h.unvvneevv98o">But why write a compiler?!</a></span></p>
    <p class="c18"><span class="c8"><a class="c11" href="#h.h2nuziw8lk6q">What are we going to compile?</a></span></p>
    <p class="c30"><span class="c0"><a class="c11" href="#h.idw5wllsm3ql">Why a Scala subset?</a></span></p>
    <p class="c18"><span class="c8"><a class="c11" href="#h.inqmlkner7vi">How are we going to compile?</a></span></p>
    <p class="c30"><span class="c0"><a class="c11" href="#h.iijz9orhx5uw">Compile-time errors</a></span></p>
    <p class="c30"><span class="c0"><a class="c11" href="#h.w1lct9kf6x6f">Compilation stages</a></span></p>
    <p class="c18"><span class="c8"><a class="c11" href="#h.q45c7qkv183x">Lexing and parsing</a></span></p>
    <p class="c18"><span class="c8"><a class="c11" href="#h.852fg7o5wy0v">Semantics</a></span></p>
    <p class="c18"><span class="c8"><a class="c11" href="#h.ov3ktfq2yx49">Assembly</a></span></p>
    <p class="c30"><span class="c0"><a class="c11" href="#h.84k06egaeq">Expressions</a></span></p>
    <p class="c18"><span class="c8"><a class="c11" href="#h.kmpuxj6z33q8">Runtime library</a></span></p>
    <p class="c30"><span class="c0"><a class="c11" href="#h.f50fls6tbx64">What can our runtime do?</a></span></p>
    <p class="c30"><span class="c0"><a class="c11" href="#h.lpnb9m9ut0ct">What can not our runtime do?</a></span></p>
    <p class="c18"><span class="c8"><a class="c11" href="#h.xgfmx7f6u5ae">Executable linking</a></span></p>
    <p class="c18">
        <span class="c8"><a class="c11" href="#h.5m4187ahcjun">Intermediate representations and optimizations</a></span>
    </p>
    <p class="c18">
        <span class="c8"><a class="c11" href="#h.nhx0ymn32qxg">If you want to learn about compilers</a></span>
    </p>
    <p class="c55"><span class="c0"><a class="c11" href="#h.6vmw7qq6gu">Advanced topics</a></span></p>
    <hr style="page-break-before:always;display:none;">
    <h1 class="c5 c52" id="h.lgikfkc7hq5a"><span class="c1"></span></h1>
    <h1 class="c5" id="h.10ihxg5fxz2w"><span class="c1">This is not a tutorial</span></h1>
    <p class="c5">
        <span>Scroll to the </span><span class="c12"><a class="c11" href="#h.nhx0ymn32qxg">end</a></span><span class="c0">
            &nbsp;for links to a couple awesome tutorials. Even if I&rsquo;d tried to make this a tutorial,
            it couldn&rsquo;t have begun to compare with one of those. A side effect of working on this write up is I
            definitely gained a new appreciation for just how talented the authors of the linked tutorials are.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            Instead, let&rsquo;s talk about design decisions and &nbsp;difficulties that came up
            while planning and writing the code. Also, we can discuss the big picture of the project&rsquo;s structure.
            Plus, while coding up the compiler, I collected a number of tips, war stories, and interesting opinions from
            compiler gurus that seem worth sharing. If you&rsquo;re curious about any of this stuff, I&rsquo;m happy,
            read on!
        </span>
    </p>
    <h1 class="c5" id="h.unvvneevv98o"><span class="c1">But why write a compiler?!</span></h1>
    <p class="c5"><span class="c0">A long time ago in a company far, far away I joined a C++ project.</span></p>
    <p class="c5">
        <span class="c0">
            We used Visual Studio 6.0 to work on it. Soon after I joined, teammates introduced me
            to Visual Assist. It&rsquo;s a plugin that improves and extends what Visual Studio can do with C++ code. At
            least back then, the plugin really impressed me: I felt like it&rsquo;s powered by a general artificial
            intelligence engine, no less.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            While Windows was our primary platform, we supported building and running the project
            on Linux. To edit the code we used KDevelop or Eclipse CDT. At the time, even an out-of-the-box install of
            Visual Studio left these two in the dust in terms of working with C++ code. Visual Assist was simply decades
            ahead. On the other hand &mdash; as I learned soon enough &mdash; if you asked to suggest an IDE for Linux,
            people would respond that the Unix command line was the most advanced IDE ever.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            So, a light bulb went on in my head: I have a chance to contribute big-time to the
            open-source community! Linus Torvalds himself will shake my hand. Maybe Red Hat will even give me some stock
            options as a present. All I have to do is improve an existing Linux C++ IDE so it&rsquo;s at least as good
            as Windows counterparts. Easy-peasy!.. Probably, this was the first time I started wondering how IDE-s and
            compilers &ldquo;understand&rdquo; code.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            Well, life had different plans. I changed jobs and switched to C# at the new company.
            So, C++ IDE-s, compilers, and Linux had to take a back seat for a long time.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            Finally, in 2019 I decided I cannot postpone wrapping my head around compiler
            construction any longer. What is the best way to learn? Of course, to apply whatever you&rsquo;re learning
            in practice. So, this project was kicked off.
        </span>
    </p>
    <h1 class="c5" id="h.h2nuziw8lk6q"><span class="c1">What are we going to compile?</span></h1>
    <p class="c5">
        <span class="c0">
            Let&rsquo;s first get a quick taste of our programming language and dive into details
            a bit later. Here&rsquo;s a small complete program in Cool 2020.
        </span>
    </p><a id="t.2cfae0461ed896a01bde2c3f4e3f8413d082ede9"></a><a id="t.0"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c22" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c3">class</span><span class="c2">&nbsp;</span><span class="c9">QuickSort</span><span class="c2">() </span><span class="c3">extends</span><span class="c2">&nbsp;</span><span class="c9">IO</span><span class="c2">
                            () {<br>
                            &nbsp;
                        </span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">quicksort</span><span class="c2">(array: </span><span class="c9">ArrayAny</span><span class="c2">, lo: </span><span class="c9">Int</span><span class="c2">, hi: </span><span class="c9">Int</span><span class="c2">): </span><span class="c9">Unit</span><span class="c2">&nbsp;= {<br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c2">
                            &nbsp;(lo &lt; hi) {<br> &nbsp; &nbsp;
                            &nbsp;
                        </span><span class="c3">var</span><span class="c2">&nbsp;p: </span><span class="c9">Int</span><span class="c2">
                            &nbsp;= partition(array, lo, hi);<br> &nbsp; &nbsp;
                            &nbsp;quicksort(array, lo, p -
                        </span><span class="c4 c13">1</span><span class="c2">
                            );<br>
                            &nbsp; &nbsp; &nbsp;quicksort(array, p +
                        </span><span class="c4 c13">1</span><span class="c2">, hi)<br> &nbsp; &nbsp;} </span><span class="c3">else</span><span class="c2">&nbsp;()<br> &nbsp;};<br> &nbsp; &nbsp;<br> &nbsp;</span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">partition</span><span class="c2">(array: </span><span class="c9">ArrayAny</span><span class="c2">
                            , lo:
                        </span><span class="c9">Int</span><span class="c2">, hi: </span><span class="c9">Int</span><span class="c2">): </span><span class="c9">Int</span><span class="c2">
                            &nbsp;= {<br> &nbsp;
                            &nbsp;
                        </span><span class="c3">var</span><span class="c2">&nbsp;pivot: </span><span class="c9">Int</span><span class="c2">&nbsp;= array.get(lo) </span><span class="c3">match</span><span class="c2">&nbsp;{ </span><span class="c3">case</span><span class="c2">&nbsp;i: </span><span class="c9">Int</span><span class="c2">
                            &nbsp;=&gt; i };<br>
                            &nbsp; &nbsp;
                        </span><span class="c3">var</span><span class="c2">&nbsp;p: </span><span class="c9">Int</span><span class="c2">&nbsp;= lo;<br> &nbsp; &nbsp;</span><span class="c3">var</span><span class="c2">&nbsp;i: </span><span class="c9">Int</span><span class="c2">&nbsp;= lo + </span><span class="c4 c13">1</span><span class="c2">
                            ;<br> &nbsp;
                            &nbsp;
                        </span><span class="c3">while</span><span class="c2">
                            &nbsp;(i &lt;= hi) {<br> &nbsp;
                            &nbsp; &nbsp;
                        </span><span class="c3">if</span><span class="c2">
                            &nbsp;(((array.get(i))
                        </span><span class="c3">match</span><span class="c2">&nbsp;{ </span><span class="c3">case</span><span class="c2">&nbsp;i: </span><span class="c9">Int</span><span class="c2">
                            &nbsp;=&gt; i }) &lt;= pivot)<br> &nbsp; &nbsp; &nbsp; &nbsp;array_swap(array, i,
                            { p = p +
                        </span><span class="c4 c13">1</span><span class="c2">
                            ; p })<br> &nbsp; &nbsp;
                            &nbsp;
                        </span><span class="c3">else</span><span class="c2">
                            <br> &nbsp; &nbsp; &nbsp;
                            &nbsp;();<br> &nbsp; &nbsp; &nbsp;i = i +
                        </span><span class="c4 c13">1</span><span class="c2">
                            <br> &nbsp; &nbsp;};<br> &nbsp; &nbsp;<br> &nbsp; &nbsp;array_swap(array, p,
                            lo);<br> &nbsp; &nbsp;p<br> &nbsp;};<br> &nbsp; &nbsp;<br> &nbsp;
                        </span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">array_swap</span><span class="c2">(array: </span><span class="c9">ArrayAny</span><span class="c2">, p: </span><span class="c9">Int</span><span class="c2">, q: </span><span class="c9">Int</span><span class="c2">): </span><span class="c9">Unit</span><span class="c2">
                            &nbsp;= {<br> &nbsp;
                            &nbsp;
                        </span><span class="c3">var</span><span class="c2">&nbsp;tmp: </span><span class="c9">Any</span><span class="c2">
                            &nbsp;= array.get(p);<br> &nbsp; &nbsp;array.set(p,
                            array.get(q));<br> &nbsp; &nbsp;array.set(q, tmp)<br> &nbsp;};<br> &nbsp; &nbsp;<br>
                            &nbsp;
                        </span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">out_array</span><span class="c2">(array: </span><span class="c9">ArrayAny</span><span class="c2">): </span><span class="c9">Unit</span><span class="c2">&nbsp;= {<br> &nbsp; &nbsp;</span><span class="c3">var</span><span class="c2">&nbsp;i: </span><span class="c9">Int</span><span class="c2">&nbsp;= </span><span class="c4 c13">0</span><span class="c2">;<br> &nbsp; &nbsp;</span><span class="c3">while</span><span class="c2">
                            &nbsp;(i &lt; array.length()) {<br> &nbsp; &nbsp;
                            &nbsp;array.get(i)
                        </span><span class="c3">match</span><span class="c2">
                            &nbsp;{<br> &nbsp;
                            &nbsp; &nbsp; &nbsp;
                        </span><span class="c3">case</span><span class="c2">
                            &nbsp;i:
                        </span><span class="c9">Int</span><span class="c2">
                            &nbsp;=&gt; out_int(i);
                            out_string(
                        </span><span class="c29 c4">&quot; &quot;</span><span class="c2">
                            )<br> &nbsp;
                            &nbsp; &nbsp;};<br> &nbsp; &nbsp; &nbsp; &nbsp;<br> &nbsp; &nbsp; &nbsp;i = i +
                        </span><span class="c4 c13">1</span><span class="c2">
                            <br> &nbsp; &nbsp;};<br> &nbsp; &nbsp;<br> &nbsp;
                            &nbsp;out_nl()<br> &nbsp;};<br> &nbsp; &nbsp;<br> &nbsp;{<br> &nbsp; &nbsp;
                        </span><span class="c3">var</span><span class="c2">&nbsp;array: </span><span class="c9">ArrayAny</span><span class="c2">&nbsp;= </span><span class="c3">new</span><span class="c2">&nbsp;</span><span class="c9">ArrayAny</span><span class="c2">(</span><span class="c4 c13">5</span><span class="c2">);<br> &nbsp; &nbsp;array.set(</span><span class="c4 c13">0</span><span class="c2">, </span><span class="c4 c13">30</span><span class="c2">);<br> &nbsp; &nbsp;array.set(</span><span class="c4 c13">1</span><span class="c2">, </span><span class="c4 c13">20</span><span class="c2">
                            );<br> &nbsp;
                            &nbsp;array.set(
                        </span><span class="c4 c13">2</span><span class="c2">, </span><span class="c4 c13">50</span><span class="c2">);<br> &nbsp; &nbsp;array.set(</span><span class="c4 c13">3</span><span class="c2">, </span><span class="c4 c13">40</span><span class="c2">);<br> &nbsp; &nbsp;array.set(</span><span class="c4 c13">4</span><span class="c2">, </span><span class="c4 c13">10</span><span class="c2">
                            );<br> &nbsp; &nbsp;<br>
                            &nbsp; &nbsp;out_array(array);<br> &nbsp; &nbsp;quicksort(array,
                        </span><span class="c4 c13">0</span><span class="c2">, array.length() - </span><span class="c4 c13">1</span><span class="c2">
                            );<br> &nbsp; &nbsp;out_array(array)<br>
                            &nbsp;};<br>}<br><br>
                        </span><span class="c3">class</span><span class="c2">&nbsp;</span><span class="c9">Main</span><span class="c2">() {<br> &nbsp;{ </span><span class="c3">new</span><span class="c2">&nbsp;</span><span class="c9">QuickSort</span><span class="c2">() };<br>}</span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c5">
        <span>Use this </span><span class="c12">
            <a class="c11"
               href="https://scastie.scala-lang.org/73sTzF0wTyWtFz2VLIV9Gw">link</a>
        </span><span class="c0">
            &nbsp;to
            run the code.
        </span>
    </p>
    <p class="c5">
        <span>Alex Aiken came up with </span><span class="c12">
            <a class="c11"
               href="https://en.wikipedia.org/wiki/Cool_(programming_language)">
                Classroom
                Object Oriented Language or COOL
            </a>
        </span><span>&nbsp;for their </span><span class="c12">
            <a class="c11"
               href="https://www.edx.org/course/compilers">
                Compilers
                course
            </a>
        </span><span>
            . While the course was one of my primary studying resources, I picked another
            language for the toy compiler &mdash;
        </span><span class="c12">
            <a class="c11"
               href="https://web.archive.org/web/20210823043833/http://www.cs.uwm.edu/classes/cs654/handout/cool-manual.pdf">
                Cool
                2020
            </a>
        </span><span>
            . The names are similar but the languages are fairly different. While COOL is an
            invention of Alex Aiken, Cool 2020 is a Scala subset (with a couple minor incompatibilities). John Boyland
            extracted and documented it.
        </span>
        <hr style="page-break-before:always;display:none;">
    </p>
    <h2 class="c26" id="h.idw5wllsm3ql"><span class="c19">Why a Scala subset?</span></h2>
    <p class="c5">
        <span>Firstly, edX hosts the Compilers course. Their </span><span class="c12">
            <a class="c11"
               href="https://support.edx.org/hc/en-us/articles/206503398-What-is-the-edX-Honor-Code-">
                Honor
                Code
            </a>
        </span><span class="c0">
            &nbsp;has a clause that prohibits posting &ldquo;answers to problems
            that are being used to assess learner performance&rdquo;. Does this clause cover the code that a student
            writes doing the course&rsquo;s exercises? I&rsquo;m not sure, but would like to steer clear of violating it
            as much as possible.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            Secondly, the course gives some amount of starter code &nbsp;and structure for its
            assignments. The student is supposed to fill in the missing pieces. Doing it is a ton of work, but still a
            bit more help and guidance than my preference for this particular project.
        </span>
    </p>
    <p class="c5">
        <span>Out of other educational programming languages I found on the Internet, </span><span class="c12">
            <a class="c11" href="http://www.cs.uwm.edu/classes/cs654/handout/cool-manual.pdf">
                Cool
                2020
            </a>
        </span><span>
            &nbsp;seemed to be the best fit. We&rsquo;ve seen a sample program earlier, you can
            take a look at an implementation of
        </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/4227fd9add146459bc869861f680265aafe4ee19/src/Tests/CoolPrograms/Runtime/Life.cool">
                Conway&rsquo;s
                Game of Life
            </a>
        </span><span>&nbsp;and </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/master/misc/Cool_2020.g4">
                the
                grammar
            </a>
        </span><span>
            &nbsp;in the project&rsquo;s repository. Please notice, the grammar ignores the
            operations precedence for the sake of simplicity. The precedence of operations is described
        </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs#precendence">here</a>
        </span><span class="c0">.</span>
    </p>
    <p class="c5">
        <span class="c0">
            Going with a Scala subset brings us some advantages. One, as Scala is quite a modern
            language, Cool 2020 too has features typical of modern programming languages. Thanks to this, we get to
            think about and solve problems similar to the problems developers of modern programming languages solve,
            though, obviously, on a hugely smaller scale.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            An example of such a feature is the way we write constructors in Cool 2020. Its
            parameters appear in parentheses just after the class name. And the constructor&rsquo;s code can be split
            across a number of code blocks appearing in curly braces inside the class body.
        </span>
    </p>
    <p class="c5">
        <span>
            Let&rsquo;s take a look at a bit of code illustrating this feature. The constructor of the
        </span><span class="c4">Greeter</span><span>&nbsp;class below has one parameter </span><span>
            &mdash;
        </span><span class="c4">name</span><span>
            . When the compiler sees this constructor parameter, it automatically
            adds an attribute
        </span><span class="c4">name</span><span>&nbsp;to the class,</span><span>
            and emits the
            code to assign the parameter to the attribute. The
        </span><span>method </span><span class="c4">speak</span><span>&nbsp;then</span><span>&nbsp;uses the attribute </span><span class="c4">name</span><span>.</span>
        <hr style="page-break-before:always;display:none;">
    </p>
    <p class="c5 c35"><span class="c0"></span></p><a id="t.310a717e1c4f44afb6752ad8030a449948bcc681"></a><a id="t.1"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c22" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c3">class</span><span class="c2">&nbsp;</span><span class="c9">Greeter</span><span class="c2">(var name: </span><span class="c9">String</span><span class="c2">) {<br> &nbsp; &nbsp;</span><span class="c3">var</span><span class="c2">&nbsp;io: </span><span class="c9">IO</span><span class="c2">&nbsp;= </span><span class="c3">new</span><span class="c2">&nbsp;</span><span class="c9">IO</span><span class="c2">();<br> &nbsp; &nbsp;<br> &nbsp; &nbsp;</span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">speak</span><span class="c2">(): </span><span class="c9">Unit</span><span class="c2">
                            &nbsp;= {<br> &nbsp;
                            &nbsp; &nbsp; &nbsp;io.out_string(
                        </span><span class="c29 c4">
                            &quot;Hello,
                            &quot;
                        </span><span class="c2">&nbsp;+ name + </span><span class="c29 c4">&quot;!&quot;</span><span class="c2">
                            );<br> &nbsp; &nbsp; &nbsp;
                            &nbsp;io.out_nl()<br> &nbsp; &nbsp;};<br>}<br><br>
                        </span><span class="c3">class</span><span class="c2">&nbsp;</span><span class="c9">Main</span><span class="c2">() { { </span><span class="c3">new</span><span class="c2">&nbsp;</span><span class="c9">Greeter</span><span class="c2">(</span><span class="c29 c4">&quot;World&quot;</span><span class="c2">
                            ).speak()
                            }; }
                        </span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c5">
        <span>
            Two, we can use Scala tools. Syntax highlighting in editors and in this document is obviously
            very nice to have.
        </span><span class="c12">
            <a class="c11"
               href="https://scastie.scala-lang.org/">Scastie</a>
        </span><span class="c0">
            &nbsp;runs Scala code right in
            the browser. It is going to be really useful for us too as we can
            run Cool 2020 programs in Scastie.
        </span>
    </p>
    <p class="c5"><span class="c0">Here are the bits of code we&rsquo;ll need to run Cool 2020 in Scastie.</span></p><a id="t.eb5c44ec1d0efc7e96502ef1be67df6cc0ee2433"></a><a id="t.2"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c22" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c3">class</span><span class="c2">&nbsp;</span><span class="c9">ArrayAny</span><span class="c2">(len: </span><span class="c9">Int</span><span class="c2">) {<br> &nbsp;</span><span class="c3">var</span><span class="c2">
                            &nbsp;_array =
                        </span><span class="c3">new</span><span class="c2">&nbsp;</span><span class="c9">Array</span><span class="c2">[</span><span class="c9">Any</span><span class="c2">](len);<br> &nbsp;</span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">length</span><span class="c2">(): </span><span class="c9">Int</span><span class="c2">&nbsp;= _array.length;<br> &nbsp;</span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">get</span><span class="c2">(i: </span><span class="c9">Int</span><span class="c2">): </span><span class="c9">Any</span><span class="c2">&nbsp;= _array(i);<br> &nbsp;</span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">set</span><span class="c2">(i: </span><span class="c9">Int</span><span class="c2">, value: </span><span class="c9">Any</span><span class="c2">): </span><span class="c9">Unit</span><span class="c2">&nbsp;= _array(i) = value;<br>}<br><br></span><span class="c3">class</span><span class="c2">&nbsp;</span><span class="c9">IO</span><span class="c2">
                            &nbsp;{<br>
                            &nbsp;
                        </span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">out_string</span><span class="c2">(s: </span><span class="c9">String</span><span class="c2">): </span><span class="c9">Unit</span><span class="c2">
                            &nbsp;= print(s);<br>
                            &nbsp;
                        </span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">out_int</span><span class="c2">(i: </span><span class="c9">Int</span><span class="c2">): </span><span class="c9">Unit</span><span class="c2">
                            &nbsp;= print(i);<br>
                            &nbsp;
                        </span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">out_nl</span><span class="c2">(): </span><span class="c9">Unit</span><span class="c2">&nbsp;= println();<br>}<br><br></span><span class="c3">object</span><span class="c2">&nbsp;</span><span class="c9">Program</span><span class="c2">
                            &nbsp;{<br>
                            &nbsp;
                        </span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">main</span><span class="c2">(args: </span><span class="c9">Array</span><span class="c2">[</span><span class="c9">String</span><span class="c2">]): </span><span class="c9">Unit</span><span class="c2">&nbsp;= {<br> &nbsp; &nbsp;</span><span class="c3">new</span><span class="c2">&nbsp;</span><span class="c9">Main</span><span class="c2">()<br> &nbsp;};<br>}</span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c5">
        <span>
            That&rsquo;s it about Cool 2020 for the moment. If you happen to be looking for a language to
            implement in your own compiler, make sure to also take a look at
        </span><span class="c12">
            <a class="c11"
               href="https://chocopy.org/">ChocoPy</a>
        </span><span class="c0">
            . It&rsquo;s very well documented, has
            static typing, classes, dynamic dispatch, nested
            functions, etc. At the same time ChocoPy manages to be concise and possible to implement in a limited time
            frame.
        </span>
    </p>
    <h1 class="c5" id="h.inqmlkner7vi"><span>How are we going to compile?</span></h1>
    <p class="c5"><span class="c0">Here&rsquo;s how.</span></p>
    <p class="c5">
        <span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 500.00px;">
            <img alt="" src="images/compilation.gif"
                 style="width: 624.00px; height: 500.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);"
                 title="">
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            Well, to reproduce what happens in the gif, we&rsquo;ll need to write a compiler. And
            to do that we need to pick a programming language to write the compiler in.
        </span>
    </p>
    <p class="c5">
        <span>In 2017 I came across </span><span class="c12">
            <a class="c11"
               href="https://www.coursera.org/learn/programming-languages">
                the
                Programming Languages course
            </a>
        </span><span>&nbsp;on Coursera. Part A is devoted to </span><span class="c12">
            <a class="c11" href="https://en.wikipedia.org/wiki/Standard_ML">
                Standard
                ML (SML)
            </a>
        </span><span class="c0">
            . To say the instructor is great would be a huge understatement. The
            code we wrote for assignments used only immutable values, recursion instead of loops, partial application.
            It didn&rsquo;t make me a hardcore functional programming proponent, but seriously broadened my horizons. On
            top of that, we used pattern matching extensively, which in combination with discriminated unions impressed
            me the most: using these two to model a lot of problems felt really natural.
        </span>
    </p>
    <p class="c5">
        <span>
            The course left me wanting to write more SML. At work we develop in C#. Which means I&rsquo;m
            most familiar and comfortable with the .NET platform. Basically, it made all kind of sense to me to try
            SML&rsquo;s closest relative on .NET &mdash;
        </span><span class="c12">
            <a class="c11"
               href="https://en.wikipedia.org/wiki/F_Sharp_(programming_language)">
                the
                F# programming language
            </a>
        </span><span>. So, I tried F# in a </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/require-named-args-fs">
                couple
            </a>
        </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/must-use-ret-val-fs">smaller</a>
        </span><span>&nbsp;</span><span class="c12"><a class="c11" href="https://github.com/mykolav/use-named-args-fs">projects</a></span><span class="c0">&nbsp;and started looking for an opportunity to use it for something bigger.</span>
    </p>
    <p class="c5">
        <span>
            A toy compiler was exactly the bigger project I was looking for. Add to this the fact the
            Internet is full of comments praising SML-family languages for just how good they are for writing compilers.
            Then notice the pretty much classic
        </span><span class="c12">
            <a class="c11"
               href="https://www.cs.princeton.edu/~appel/modern/ml/">
                Tiger
                book
            </a>
        </span><span class="c0">
            &nbsp;has its code samples in SML. And you&rsquo;ll see how it was a no
            brainer to settle on F# for this project.
        </span>
    </p>
    <p class="c5">
        <span>Now, that we&rsquo;ve decided on F#</span><span>, let&rsquo;s</span><span>
            &nbsp;get one thing
            out of the way: please don&rsquo;t expect to find purely functional code in the repository. While writing
            the code, I quickly realised trying to stick to functional programming concepts and learning about compilers
            was a little bit more than I could handle at the same time. So, there is mutable state, loops, and classes
            in the code.
        </span>
    </p>
    <h2 class="c26" id="h.iijz9orhx5uw"><span>Compile-time errors</span></h2>
    <p class="c5">
        <span class="c0">
            Before we get down to coding, let&rsquo;s do a bit of planning. One thing to decide
            on is what our compiler is supposed to do when it encounters an error in the user&rsquo;s code.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            The simplest thing to do is to output a message telling the user about the error and
            stop translation once the compiler found the first error. As a result, if there are multiple errors in the
            code, the user will have to restart compilation multiple times to catch them all. It doesn&rsquo;t make for
            a good user experience.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            A very different approach exists. When the compiler detects an error it informs the
            user, but instead of stopping, it keeps analysing the code. The goal is to find and report as many errors as
            possible in a single run. So that the user can fix all of them and then &mdash; &nbsp;ideally &mdash;
            restart compilation only once.
        </span>
    </p>
    <p class="c5">
        <span>Let&rsquo;s discuss one</span><span>&nbsp;downside</span><span class="c0">
            &nbsp;of this
            approach. It requires the compiler&rsquo;s code to be noticeably more complicated. As the compiler has to
            use heuristics reducing cascading errors.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            What&rsquo;s a cascading error? The Scala code sample below contains one error. The
            closing parenthesis is missing in line 2.
        </span>
    </p><a id="t.b5503f812dbd5a88cbcde2412a90420525cf4147"></a><a id="t.3"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c22" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c7 c4">/* 1 */</span><span class="c2">&nbsp;</span><span class="c3">class</span><span class="c2">&nbsp;</span><span class="c9">CascadingError</span><span class="c2">&nbsp;{<br></span><span class="c7 c4">
                            /* 2
                            */
                        </span><span class="c2">&nbsp; &nbsp; &nbsp;</span><span class="c3">def</span><span class="c2">&nbsp;</span><span class="c25">force</span><span class="c2">(: </span><span class="c9">Unit</span><span class="c2">&nbsp;= {<br></span><span class="c7 c4">
                            /* 3
                            */
                        </span><span class="c2">&nbsp; &nbsp; &nbsp;};<br></span><span class="c7 c4">
                            /* 4
                            */
                        </span><span class="c2">&nbsp;}</span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c5">
        <span>But the Scala compiler </span><span class="c12">
            <a class="c11"
               href="https://scastie.scala-lang.org/sBJyZ6WWSHeYWzx2daD9XA">
                diagnoses
                two errors
            </a>
        </span><span class="c0">
            . It gets &ldquo;confused&rdquo; after seeing the first one, which
            is real. As a result, it reports the second error in line 3, where there is no actual problem with the code,
            &mdash; this is a cascading error.
        </span>
    </p><a id="t.26569f7f9c69a52e27125af086f7cbe8f76ca29c"></a><a id="t.4"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c22" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c2">
                            CascadingError.scala:2: error: identifier expected but &#39;:&#39;
                            found.<br> &nbsp; &nbsp;def speak(: Unit = {<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                            &nbsp;^<br>CascadingError.scala:3: error: &#39;:&#39; expected but &#39;;&#39; found.<br>
                            &nbsp; &nbsp;};<br> &nbsp; &nbsp; ^
                        </span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c5">
        <span>In some cases, cascading errors make diagnostic messages so noisy, </span><span class="c12">
            <a class="c11"
               href="https://stackoverflow.com/questions/27493895/make-scala-compiler-stop-on-first-error">
                users
                start looking for a way to make the compiler stop after the first encountered error
            </a>
        </span><span class="c0">
            . Trying to figure out which errors are real and which are just cascading and will go away when
            the user fixes the real ones is just not worth it in such cases.
        </span>
    </p>
    <p class="c5">
        <span>
            To try and get the best of both worlds, some compilers combine the two error handling strategies
            we just discussed. A great example of going this way is the C# compiler. Here&rsquo;s a short description
            Eric Lippert gave on
        </span><span class="c12">
            <a class="c11"
               href="https://stackoverflow.com/a/4698306/818321">StackOverflow</a>
        </span><span class="c0">:</span>
    </p>
    <p class="c14 c32">
        <span class="c0">
            Briefly, the way the compiler works is it tries to get the program through a
            series of stages...
        </span>
    </p>
    <p class="c14 c32">
        <span>
            The idea is that if an early stage gets an error, we might not be able to successfully
            complete a later stage without (1) going into an infinite loop, (2) crashing, or
        </span><span class="c36">(3) reporting crazy &quot;cascading&quot; errors</span><span class="c0">
            . So what happens is,
            you get one error, you fix it, and then suddenly the next stage of compilation can run, and it finds a bunch
            more errors.
        </span>
    </p>
    <p class="c14 c32"><span class="c0">...</span></p>
    <p class="c14 c32">
        <span>The </span><span>up side</span><span>&nbsp;of this design is that </span><span class="c36">
            (1) you get the errors that are the most &quot;fundamental&quot; first, without a lot of noisy,
            crazy cascading errors,
        </span><span class="c0">
            and (2) the compiler is more robust because it doesn&#39;t
            have to try to do analysis on programs where the basic invariants of the language are broken. The down side
            is of course your scenario: that you have fifty errors, you fix them all, and suddenly fifty more appear.
            [emphasis added]
        </span>
    </p>
    <p class="c5">
        <span>Let&rsquo;s see how this idea translates into </span><span class="c12">
            <a class="c11"
               href="https://github.com/dotnet/roslyn/blob/80e9227e49088d53eda930ecdee87a82c665ffd1/src/Compilers/Core/Portable/CommandLine/CommonCompiler.cs#L929">
                the
                C# compiler&rsquo;s source code
            </a>
        </span><span>. The method </span><span class="c4">CompileAndEmit</span><span>&nbsp;of the class </span><span class="c4">Microsoft.CodeAnalysis.CommonCompiler</span><span>
            &nbsp;organizes the work related to compilation
            of C# and VB.NET. Notice the invocations of
        </span><span class="c4">compilation.GetDiagnostics</span><span>
            ,
            each one has a different value from the enum
        </span><span class="c4">CompilationStage</span><span>
            &nbsp;as
            its argument. Every invocation is followed by a number of checks: did the translation stage complete
            successfully, should the translation stop or move to the next stage?
        </span>
    </p>
    <h2 class="c26" id="h.w1lct9kf6x6f"><span class="c19">Compilation stages</span></h2>
    <p class="c5">
        <span class="c0">
            We&rsquo;re going to follow the combined error handling strategy as best we can. Of
            course our code is going to be much simpler than the C# compiler&rsquo;s. Let&rsquo;s split compilation into
            the following stages.
        </span>
    </p>
    <ul class="c38 lst-kix_6dtc33tnykn6-0 start">
        <li class="c14 c21 li-bullet-0"><span class="c0">Lexical analysis, or simply lexing;</span></li>
        <li class="c14 c21 li-bullet-0"><span class="c0">Syntactic analysis, or simply parsing;</span></li>
        <li class="c14 c21 li-bullet-0"><span class="c0">Semantic analysis;</span></li>
        <li class="c14 c21 li-bullet-0"><span class="c0">Emitting x86-64 assembly.</span></li>
    </ul>
    <p class="c14">
        <span class="c0">
            Within one compilation stage, we&rsquo;re going to try and diagnose as many errors
            in the user&rsquo;s code as possible. But the next stage will only start if we don&rsquo;t detect any errors
            at the current one. Let&rsquo;s say the compiler found syntactic errors at the parsing stage, in such a case
            semantic analysis wouldn&rsquo;t even start.
        </span>
    </p>
    <p class="c14">
        <span class="c0">
            The same idea applies to the lexing and parsing stages. If there are portions of the
            program&rsquo;s text we didn&rsquo;t manage to turn into tokens while lexing, parsing isn&rsquo;t going to
            start, the compiler will stop instead.
        </span>
    </p>
    <p class="c14">
        <span>To see these ideas reflected in the project&rsquo;s code, take a look at </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/ac1fc156246dfebfed143ae0ed89b83b5dccdd08/src/LibCool/DriverParts/CompileToAsmStep.fs">CompileToAsmStep.fs</a>
        </span><span>
            &nbsp;and
            the method
        </span><span class="c4">Invoke</span><span>&nbsp;</span><span>of </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/ac1fc156246dfebfed143ae0ed89b83b5dccdd08/src/LibCool/DriverParts/EmitExeHandler.fs">EmitExeHandler</a>
        </span><span>.</span>
    </p>
    <p class="c14">
        <span>
            Also, we simplify things a lot here compared to the C# compiler. As it performs lexing and
            parsing at the same time. If the C#
        </span><span>compiler&rsquo;s</span><span class="c0">
            &nbsp;lexer cannot
            recognize a token, the parser handles this scenario and keeps going anyway. But semantic analysis will not
            start, if lexical or syntactic errors exist in the code &mdash; translation terminates.
        </span>
    </p>
    <h1 class="c14" id="h.q45c7qkv183x"><span class="c1">Lexing and parsing</span></h1>
    <p class="c5"><span class="c0">First things first, we need a lexer and a parser.</span></p>
    <p class="c5">
        <span class="c0">
            The lexer&rsquo;s goal is to take in source code as a sequence of characters and
            recognize tokens in it. A token can be a number literal, a string literal, an identifier, a language
            keyword, an operator, a punctuation mark, etc. In our specific case, we&rsquo;ll throw away any whitespace
            and comments.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            Next, the parser will try to convert its input sequence of tokens into an abstract
            syntax tree (AST).
        </span>
    </p>
    <p class="c5">
        <span>
            An AST represents the structure of a program&rsquo;s text in the form of a tree. In other words,
            as far as compilation goes, it&rsquo;s hard to do anything useful with a character sequence. But a tree is a
            much more appropriate data structure to work with. That&rsquo;s why we&rsquo;ll organize the next
            translation stages around the AST.
        </span>
        <hr style="page-break-before:always;display:none;">
    </p>
    <p class="c5 c35"><span class="c0"></span></p><a id="t.199b773465009292432237e7dc3c7af40d7dacc1"></a><a id="t.5"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c28" colspan="1" rowspan="1">
                    <p class="c27"><span>A program&rsquo;s text</span></p>
                </td>
                <td class="c39" colspan="1" rowspan="1">
                    <p class="c27"><span>The AST, serialized into JSON</span></p>
                </td>
            </tr>
            <tr class="c6">
                <td class="c28 c47" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c3">class</span><span class="c2">&nbsp;</span><span class="c9">Main</span><span class="c2">() { <br> &nbsp;</span><span class="c3">var</span><span class="c2">&nbsp;io: </span><span class="c9">IO</span><span class="c2">&nbsp;= </span><span class="c3">new</span><span class="c2">&nbsp;</span><span class="c9">IO</span><span class="c2 c24 c50">
                            ();<br><br> &nbsp;{<br> &nbsp;
                            &nbsp;io.out_string(
                        </span>
                    </p>
                    <p class="c10">
                        <span class="c4 c29">
                            &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;Hello,
                            World!&quot;
                        </span><span class="c2">
                            );<br> &nbsp; &nbsp;io.out_nl()<br> &nbsp;};
                            <br>}
                        </span>
                    </p>
                </td>
                <td class="c39 c47" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c3">{ &quot;classes&quot;: [<br> &nbsp;{ &quot;name&quot;: </span><span class="c16">&quot;Main&quot;</span><span class="c3">
                            , <br> &nbsp;
                            &nbsp;&quot;varformals&quot;: [],<br> &nbsp; &nbsp;&quot;extends&quot;: { &quot;type&quot;:
                        </span><span class="c16">&quot;Any&quot;</span><span class="c3">
                            , <br> &nbsp; &nbsp; &nbsp;
                            &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;actuals&quot;: [] },<br> &nbsp;
                            &nbsp;&quot;body&quot;: [<br> &nbsp; &nbsp; { &quot;kind&quot;:
                        </span><span class="c16">&quot;attribute&quot;</span><span class="c3">
                            , <br> &nbsp; &nbsp; &nbsp;
                            &quot;name&quot;:
                        </span><span class="c16">&quot;io&quot;</span><span class="c3">
                            ,
                            &quot;type&quot;:
                        </span><span class="c16">&quot;IO&quot;</span><span class="c3">
                            ,<br>
                            &nbsp; &nbsp; &nbsp; &quot;value&quot;: { &quot;kind&quot;:
                        </span><span class="c16">&quot;new&quot;</span><span class="c3">
                            , <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                            &nbsp; &nbsp; &nbsp; &nbsp;&quot;type&quot;:
                        </span><span class="c16">&quot;IO&quot;</span><span class="c3">
                            , <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                            &nbsp; &nbsp; &nbsp; &nbsp;&quot;actuals&quot;: [] } },<br> &nbsp; &nbsp; {
                            &quot;kind&quot;:
                        </span><span class="c16">&quot;block&quot;</span><span class="c3">
                            ,<br>
                            &nbsp; &nbsp; &nbsp; &quot;statements&quot;: [<br> &nbsp; &nbsp; &nbsp; &nbsp;{
                            &quot;kind&quot;:
                        </span><span class="c16">&quot;stmt&quot;</span><span class="c3">
                            ,<br>
                            &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;expr&quot;: <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{
                            &quot;kind&quot;:
                        </span><span class="c16">&quot;dispatch&quot;</span><span class="c3">
                            ,<br>
                            &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;receiver&quot;:
                        </span><span class="c16">&quot;io&quot;</span><span class="c3">
                            ,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                            &nbsp;&quot;method&quot;:
                        </span><span class="c16">&quot;out_string&quot;</span><span class="c3">
                            , <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;actuals&quot;: [
                        </span><span class="c16">&quot;\&quot;Hello, World!\&quot;&quot;</span><span class="c3">
                            &nbsp;]
                            } <br> &nbsp; &nbsp; &nbsp; &nbsp;},<br> &nbsp; &nbsp; &nbsp; &nbsp;{ &quot;kind&quot;:
                        </span><span class="c16">&quot;expr&quot;</span><span class="c3">
                            ,<br> &nbsp; &nbsp; &nbsp;
                            &nbsp; &nbsp;&quot;expr&quot;: <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ &quot;kind&quot;:
                        </span><span class="c16">&quot;dispatch&quot;</span><span class="c3">
                            , <br> &nbsp; &nbsp; &nbsp;
                            &nbsp; &nbsp; &nbsp;&quot;receiver&quot;:
                        </span><span class="c16">&quot;io&quot;</span><span class="c3">
                            ,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                            &nbsp;&quot;method&quot;:
                        </span><span class="c16">&quot;out_nl&quot;</span><span class="c3 c24 c50">
                            , <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;actuals&quot;: [] }
                            <br> &nbsp; &nbsp; &nbsp; &nbsp;}<br> &nbsp; &nbsp; &nbsp;]<br> &nbsp; &nbsp; }<br> &nbsp;
                            &nbsp;] } ] }
                        </span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c5">
        <span>
            There are a number of ways to get the AST from source code: parser generators such as
        </span><span class="c12">
            <a class="c11" href="https://www.gnu.org/software/bison/">
                GNU
                Bison
            </a>
        </span><span>&nbsp;and </span><span class="c12">
            <a class="c11"
               href="https://www.antlr.org/">ANTLR</a>
        </span><span>
            ;
            parser combinators libraries such as
        </span><span class="c12">
            <a class="c11"
               href="https://hackage.haskell.org/package/parsec">Parsec</a>
        </span><span class="c0">
            ; writing a lexer
            and a parser from scratch. Which one should we go with? Well, if we have a
            chance to gain experience at least remotely similar to writing an enterprise-grade compiler, we should take
            that chance.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            As far as I can tell, the teams of most contemporary enterprise-grade compilers built
            their lexers and recursive-descent parsers by hand. Some of them are: GCC, Clang, D, Rust, Swift, Go, Java,
            V8, TypeScript, C#, VB.NET.
        </span>
    </p>
    <p class="c14">
        <span>Here&rsquo;s how one of the C# compiler&rsquo;s developers </span><span class="c12">
            <a class="c11" href="https://news.ycombinator.com/item?id=13915150">explained</a>
        </span><span class="c0">&nbsp;their decision to implement their lexer and parser manually.</span>
    </p>
    <p class="c14 c61">
        <span class="c0">
            Hello, I work on the C# compiler and we use a handwritten recursive-descent
            parser. Here are a few of the more important reasons for doing so:
        </span>
    </p>
    <ul class="c38 lst-kix_3hi1kckz9g8d-0 start">
        <li class="c14 c15 li-bullet-0">
            <span class="c0">
                Incremental re-parsing. If a user in the IDE changes the
                document, we need to reparse the file, but we want to do this while using as little memory as possible.
                To this end, we re-use AST nodes from previous parses.
            </span>
        </li>
        <li class="c14 c15 li-bullet-0">
            <span class="c0">
                Better error reporting. Parser generators are known for
                producing terrible errors. While you can hack around this, by using recursive-descent, you can get
                information from further &quot;up&quot; the tree to make it more relevant to the context in which the
                error occurred.
            </span>
        </li>
        <li class="c14 c15 li-bullet-0">
            <span>
                Resilient parsing. This is the big one! If you give our parser a string
                that is illegal according to the grammar, our parser will still give you a syntax tree! (We&#39;ll also
                spit errors out). But getting a syntax tree regardless of the actual validity of the program being
                passed in means that the IDE
            </span><span>can give autocomplete</span><span>
                &nbsp;and report
                type-checking error messages. As an example, the code `
            </span><span class="c4">
                var x =
                velocity.`
            </span><span>&nbsp;is invalid C#. However, in order to give autocomplete on `</span><span class="c4">velocity.</span><span class="c0">
                `, that code needs to be parsed into an AST, and then
                typechecked, and then we can extract the members on the type in order to provide a good user
                experience.
            </span>
        </li>
    </ul>
    <hr style="page-break-before:always;display:none;">
    <p class="c5 c35"><span class="c0"></span></p>
    <p class="c5">
        <span>
            The story of GCC&rsquo;s parser seems to be quite a bright example. GCC started out using the
            Bison parser generator, but in 2004 the developers decided to
        </span><span class="c12">
            <a class="c11"
               href="https://en.wikipedia.org/wiki/GNU_Bison#Use">switch</a>
        </span><span>
            &nbsp;to
            a handwritten recursive-descent parser. Apparently, migrating turned out to be easier than trying to get
            around Bison&#39;s limitations. In the
        </span><span class="c12">
            <a class="c11"
               href="https://gcc.gnu.org/gcc-3.4/changes.html">changelog</a>
        </span><span class="c0">
            , you can read the
            following.
        </span>
    </p>
    <p class="c14 c32">
        <span class="c48">
            A hand-written recursive-descent C++ parser has replaced the YACC-derived C++
            parser from previous GCC releases. The new parser contains much improved infrastructure needed for better
            parsing of C++ source codes, handling of extensions, and clean separation (where possible) between proper
            semantics analysis and parsing.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            Now that we&rsquo;ve considered all of the info above, the choice is clear:
            we&rsquo;re going to write our lexer and parser by hand. In fact, it&rsquo;s not difficult.
        </span>
    </p>
    <p class="c5">
        <span>In </span><span>their</span><span>&nbsp;book </span><span class="c12">
            <a class="c11"
               href="https://craftinginterpreters.com/contents.html">
                Crafting
                Interpreters
            </a>
        </span><span>,</span><span>&nbsp;Robert Nystrom explains writing </span><span class="c12">
            <a class="c11"
               href="https://craftinginterpreters.com/scanning.html">lexers</a>
        </span><span>
            &nbsp;and
        </span><span class="c12">
            <a class="c11"
               href="https://craftinginterpreters.com/parsing-expressions.html#recursive-descent-parsing">
                recursive-descent
                parsers
            </a>
        </span><span class="c0">
            &nbsp;really, really well. Our parser is going to be
            recursive-descent too.
        </span>
    </p>
    <p class="c5">
        <span>The lexer&rsquo;s code is in </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/ParserParts/Lexer.fs">Lexer.fs</a>
        </span><span>
            ,
            if you feel like untangling it, consider starting from the method
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/ParserParts/Lexer.fs#L469">GetNext</a>
        </span><span>
            .
            The parser&rsquo;s code is in
        </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/ParserParts/Parser.fs">Parser.fs</a>
        </span><span>
            ,
            and the method
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/ParserParts/Parser.fs#L1525">Parser.Parse</a>
        </span><span>
            &nbsp;is
            its entry point.
        </span>
    </p>
    <h1 class="c5" id="h.852fg7o5wy0v"><span class="c1">Semantics</span></h1>
    <p class="c5"><span class="c0">Once parsing completes, the next compilation stage is semantic analysis.</span></p>
    <p class="c5">
        <span>Eric Lippert wrote a very interesting blog post </span><span class="c12">
            <a class="c11"
               href="https://docs.microsoft.com/en-us/archive/blogs/ericlippert/how-many-passes">
                How
                many passes?
            </a>
        </span><span>
            . It lists some of the passes the C#
        </span><span>compiler</span><span>
            &nbsp;performs and gives a bit of details on each. Spoilers ahead! There are
            more than twenty passes. Many of them are related to semantic analysis.
        </span>
    </p>
    <p class="c5">
        <span>We&rsquo;re going to perform semantic analysis over three passes. The method </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/Translator.fs#L40">Translator.Translate</a>
        </span><span>
            &nbsp;is
            responsible for starting the analysis passes one after another and checking their results.
        </span><span class="c0">&nbsp;</span>
    </p>
    <p class="c5">
        <span class="c0">
            The first semantic pass is the simplest. The only thing it&rsquo;s going to do is
            create a map, where the key is a class&rsquo; name and the value is the AST node corresponding to this
            class. We&rsquo;ll need this map to look up class names during the second pass.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            In case we meet two or more classes with the same name, we&rsquo;ll report an error
            and stop compilation.
        </span>
    </p>
    <p class="c5">
        <span>The first semantic pass is implemented by the function </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/Translator.fs#L16">collect_class_nodes</a>
        </span><span>
            &nbsp;from
        </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/Translator.fs">Translator.fs</a>
        </span><span class="c0">.</span>
    </p>
    <p class="c5">
        <span class="c0">
            In the scope of the second semantic pass we&rsquo;ll go over class definitions, their
            attributes and methods, but will not &ldquo;look&rdquo; inside the methods&rsquo; bodies. Along the way,
            we&rsquo;ll form a class metadata map, where the key is again a class&rsquo; name, but the value this time
            is the list of the class&rsquo; attributes and methods with all the associated types. This map will come in
            handy while performing the third semantic pass. Also the second pass makes sure:
        </span>
    </p>
    <ul class="c38 lst-kix_v286z3ghxlg6-0 start">
        <li class="c14 c21 li-bullet-0"><span class="c0">There are no loops in the inheritance hierarchy;</span></li>
        <li class="c14 c21 li-bullet-0">
            <span class="c0">
                All classes referenced by name in the source code have
                definitions;
            </span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span class="c0">
                There are no methods which have two or more parameters with the
                same name;
            </span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span class="c0">
                The source code is free from a number of other similar
                problems.
            </span>
        </li>
    </ul>
    <p class="c5">
        <span class="c0">
            In case, the second pass finds any semantic problems, the compiler informs the user
            about every one of them and stops.
        </span>
    </p>
    <p class="c5">
        <span>The second semantic pass is implemented by the class </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/SemanticParts/ClassSymbolCollector.fs#L60">ClassSymbolCollector</a>
        </span><span>
            .
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/Translator.fs#L40">Translator.Translate</a>
        </span><span>
            &nbsp;sets
            up the second pass and starts it by a call to
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/SemanticParts/ClassSymbolCollector.fs#L402">ClassSymbolCollector.Collect</a>
        </span><span class="c0">.</span>
    </p>
    <p class="c5">
        <span>
            We&rsquo;re at a point where we have the class metadata map, so it&rsquo;s time to start the
            third semantic pass. What do we need the class metadata map for? Let&rsquo;s say the third pass is looking
            at a method&rsquo;s invocation
        </span><span class="c4">instance.some_method()</span><span>.</span><span>
            &nbsp;Thanks to having the metadata map, we can
            make sure
        </span><span class="c4">some_method</span><span>
            &nbsp;is actually defined in the class of
        </span><span class="c4">instance</span><span>.</span>
    </p>
    <p class="c5">
        <span>
            The third semantic pass analyses methods&rsquo; bodies. It makes sure the code doesn&rsquo;t
            contain attempts to assign a string value to an
        </span><span class="c4">Int</span><span>
            &nbsp;variable. Or
            pass an
        </span><span class="c4">Int</span><span>&nbsp;argument to a method that expects a </span><span class="c4">String</span><span>. It also checks for other similar errors.</span>
    </p>
    <p class="c5">
        <span>
            Another thing the third pass needs is a symbol table. A symbol table maps names from the current
            lexical scope to a collection of details on this name: does the name refer to a variable, a parameter, or an
            attribute; what&rsquo;s its type, etc. If a name is not defined or not visible in the current scope, it
            won&rsquo;t be present in the symbol table. Check out the class
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/38cb3a58006bd18828eb62d04072523df143268e/src/LibCool/TranslatorParts/SymbolTable.fs#L113">SymbolTable</a>
        </span><span>
            &nbsp;to
            see the code.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            Apart from diagnosing semantic errors, the third pass could build a new tree of the
            same shape as AST, but extended with additional info: the type of each node, list and description of
            parameters and the return type for method nodes, etc. To keep the amount of code down and its complexity in
            check, we&rsquo;re going to skip generating an intermediate tree. Instead, we&rsquo;ll combine the third
            semantic pass and assembly generation.
        </span>
    </p>
    <p class="c5">
        <span>The class </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/ExprTranslator.fs#L15">ExprTranslator</a>
        </span><span>
            &nbsp;contains
            the third pass&rsquo; code.
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/ExprTranslator.fs#L1279">ExprTranslator.Translate</a>
        </span><span>
            &nbsp;is
            the entry point.
        </span>
    </p>
    <h1 class="c5" id="h.ov3ktfq2yx49"><span class="c1">Assembly</span></h1>
    <p class="c5">
        <span class="c0">
            OK, the parser built an AST for us. Along the way, the compiler made sure the code
            doesn&rsquo;t contain syntactic or semantic errors. Now we&rsquo;re going to walk the AST and emit assembly
            in the process. We&rsquo;ll turn the assembly into an executable a bit later.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            The Compilers course and many other learning materials have MIPS as their target for
            assembly generation. Surely, they have very good reasons for that and the fundamentals of generating
            assembly don&rsquo;t depend on the particular instruction set architecture anyway. But in practice, I
            personally find generating x86-64 assembly much, much more motivating and rewarding. You need an emulator to
            run MIPS assembly &mdash; that is, unless you own an SGI workstation or a Tesla Model S. In contrast,
            executables produced from x86-64 assembly code can run natively on Windows or Linux right on a boring
            desktop PC.
        </span>
    </p>
    <p class="c5">
        <span>
            Producing native executables has one more practical advantage, it makes it much simpler to
            automate compilation and execution of test programs to check the results of their work.
        </span>
        <hr style="page-break-before:always;display:none;">
    </p>
    <p class="c5">
        <span>
            Here&rsquo;s an example of a test program. If the results of building and execution of a test
            program don&rsquo;t match the
        </span><span class="c4">DIAG</span><span>
            &nbsp;and
        </span><span>&nbsp;</span><span class="c4">OUT</span><span>
            &nbsp;comments respectively, we consider the test
            failed.
        </span>
    </p><a id="t.75aae37183c21e17ae072b318abd4bd29344a2c2"></a><a id="t.6"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c22" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c3">class</span><span class="c2">&nbsp;</span><span class="c9">Main</span><span class="c2">() {<br> &nbsp;{<br> &nbsp; &nbsp;</span><span class="c3">var</span><span class="c2">&nbsp;io: </span><span class="c9">IO</span><span class="c2">&nbsp;= </span><span class="c3">new</span><span class="c2">&nbsp;</span><span class="c9">IO</span><span class="c2">();<br> &nbsp; &nbsp;io.out_string(</span><span class="c29 c4">&quot;Hello, Cool2020!&quot;</span><span class="c2">
                            );<br> &nbsp;
                            &nbsp;io.out_nl()<br> &nbsp;};<br>}<br>
                        </span><span class="c7 c4">
                            // DIAG: Build succeeded:
                            Errors: 0. Warnings: 0
                        </span><span class="c2"><br></span><span class="c7 c4">
                            // OUT: Hello,
                            Cool2020!
                        </span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <h2 class="c26" id="h.84k06egaeq"><span class="c19">Expressions</span></h2>
    <p class="c5">
        <span>
            Emitting assembly corresponding to control flow statements is rather straightforward. For
            example, imagine we had to organize a loop using only
        </span><span class="c4">if</span><span>
            &nbsp;and
        </span><span class="c4">goto</span><span>
            &nbsp;statements. To a first approximation, we organize loops in
            assembly in the same way.
        </span>
    </p>
    <p class="c5">
        <span>
            Translating expressions is more interesting. A program in assembly language is a sequence of
            instructions, each has from zero to three operands. There is no assembly instruction that can evaluate a
            simplest expression like
        </span><span class="c4">a + b + c + d</span><span>
            . And expressions can be way more
            complex: contain parenthesis, different math operations, methods invocations...
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            So, what can we do? The idea is to &ldquo;pretend&rdquo; that instead of one complex
            expression we have multiple simple expressions. An expression is simple if we can trivially translate it
            into assembly. Let&rsquo;s take a look at a bit of pseudocode.
        </span>
    </p><a id="t.df743f4cd519716189428d3584e05fa99ff433df"></a><a id="t.7"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c54" colspan="1" rowspan="1">
                    <p class="c27"><span class="c0">Complex expression</span></p>
                </td>
                <td class="c58" colspan="1" rowspan="1">
                    <p class="c27"><span class="c0">Multiple simple expressions</span></p>
                </td>
            </tr>
            <tr class="c6">
                <td class="c20" colspan="1" rowspan="1">
                    <p class="c10"><span class="c2">a + b + c + d</span></p>
                </td>
                <td class="c43" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c3">var</span><span class="c2">&nbsp;tmp0: </span><span class="c9">Int</span><span class="c2">;<br></span><span class="c3">var</span><span class="c2">&nbsp;tmp1: </span><span class="c9">Int</span><span class="c2">;<br></span><span class="c3">var</span><span class="c2">&nbsp;result: </span><span class="c9">Int</span><span class="c2">;<br><br>tmp0 = a;<br>tmp1 = b;<br>tmp0 = tmp0 + tmp1; </span><span class="c7 c4">// tmp0 = a + b</span><span class="c2">
                            <br><br>tmp1 = c;<br>tmp0 = tmp0 +
                            tmp1;
                        </span><span class="c7 c4">// tmp0 = a + b + c</span><span class="c2">
                            <br> &nbsp;
                            &nbsp;<br>tmp1 = d;<br>tmp0 = tmp0 + tmp1;
                        </span><span class="c7 c4">
                            // tmp0 = a + b + c +
                            d
                        </span><span class="c2">
                            <br> &nbsp; &nbsp;<br>result = tmp0 &nbsp; &nbsp; &nbsp;
                        </span><span class="c7 c4">// result = a + b + c + d</span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c5">
        <span class="c0">
            To better understand how this idea applies to practice, let&rsquo;s follow a detailed
            example.
        </span>
    </p>
    <p class="c5">
        <span>We&rsquo;re translating </span><span class="c4">a + b + c + d</span><span class="c0">.</span>
    </p>
    <ul class="c38 lst-kix_ivj9gkbkx2b4-0 start">
        <li class="c14 c21 li-bullet-0">
            <span>Adding parentheses to the expressions we get </span><span class="c4">
                ([(a
                + b) + c] + d)
            </span><span class="c0">
                . (In this case, square brackets are equal to parentheses, we use
                them to make reading easier.)
            </span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span>
                Now, we&rsquo;re moving the plus signs to the left, such that
                they&rsquo;re placed before the corresponding terms:
            </span><span class="c4">
                (+ [+ (+ a b) c]
                d)
            </span><span class="c0">.</span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span>
                The last form of expression represents a tree. Hopefully, an ASCII diagram
                makes it obvious.
            </span>
        </li>
    </ul>
    <a id="t.3dd63a346826eac1346add24e785ad4792f39a9e"></a><a id="t.8"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c22" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c2">
                            + <br>&#9500;&#9472;&#9472; + <br>&#9474; &nbsp;
                            &#9500;&#9472;&#9472; + <br>&#9474; &nbsp; &#9474; &nbsp; &#9500;&#9472;&#9472; a
                            <br>&#9474; &nbsp; &#9474; &nbsp; &#9492;&#9472;&#9472; b<br>&#9474; &nbsp;
                            &#9492;&#9472;&#9472; c<br>&#9492;&#9472;&#9472; d
                        </span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c14">
        <span>
            Let&rsquo;s perform a post-order (LRN) traversal of this tree. When the post-order function
            finishes visiting both subtrees, it will print an assembly instruction corresponding to the current tree
            node. The post-order function will return the name of the register holding the result of the subtree&rsquo;s
            expression evaluation.
        </span>
        <hr style="page-break-before:always;display:none;">
    </p>
    <p class="c14">
        <span>
            If we trace the tree&rsquo;s post-order traversal, we&rsquo;ll see the following (using
        </span><span class="c12">
            <a class="c11"
               href="https://en.wikipedia.org/wiki/X86_assembly_language#Syntax">
                AT&amp;T
                syntax
            </a>
        </span><span class="c0">).</span>
    </p><a id="t.1a67b82d54eef33d9111fd91754a9f3a65af6024"></a><a id="t.9"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c22" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c7 c4"># Entering the root node `+`</span><span class="c2"><br></span><span class="c7 c4">
                            # The node has two subtrees: `[+ (+ a b) c]` and
                            `d`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # Recursively invoking the
                            post-order function for the left subtree
                        </span><span class="c2"><br></span><span class="c7 c4">#</span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; Entering the
                            `+` node of the subtree `[+ (+ a b) c]`
                        </span><span class="c2"><br></span><span class="c7 c4"># &nbsp; The node has two subtrees: `(+ a b)` and `c`</span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; Recursively invoking the post-order
                            function for the left subtree
                        </span><span class="c2"><br></span><span class="c7 c4">
                            #
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; Entering the `+` node of
                            the subtree `(+ a b)`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp;
                            The node has two leaf nodes as its subtrees: `a` and `b`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; Recursively invoking the
                            post-order function for the left subtree
                        </span><span class="c2"><br></span><span class="c7 c4"># </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp;
                            &nbsp; Entering the `a` node
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp;
                            &nbsp; &nbsp; Picking an unused register %rbx to load the value `a` into it
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; &nbsp; Printing the assembly
                            instruction
                        </span><span class="c2"><br></span><span class="c3">mov</span><span class="c2">&nbsp; &nbsp; a, &nbsp; %rbx<br></span><span class="c7 c4">
                            # &nbsp; &nbsp; &nbsp;
                            Returning the name of the register %rbx
                        </span><span class="c2"><br></span><span class="c7 c4"># &nbsp; &nbsp; &nbsp; %rbx contains the value at the address `a`</span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; &nbsp; Leaving the `a`
                            node
                        </span><span class="c2"><br></span><span class="c7 c4"># </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; Recursively invoking the
                            post-order function for the right subtree
                        </span><span class="c2"><br></span><span class="c7 c4"># </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp;
                            &nbsp; Entering the `b` node
                        </span><span class="c2"><br></span><span class="c4 c7">
                            # &nbsp;
                            &nbsp; &nbsp; Picking an unused register %r10 to load the value `b` into it
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; &nbsp; Printing the assembly
                            instruction
                        </span><span class="c2"><br></span><span class="c3">mov</span><span class="c2">&nbsp; &nbsp; b, &nbsp; %r10<br></span><span class="c7 c4">
                            # &nbsp; &nbsp; &nbsp;
                            Returning the name of the register %r10
                        </span><span class="c2"><br></span><span class="c7 c4"># &nbsp; &nbsp; &nbsp; %r10 contains the value at the address `b`</span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; &nbsp; Leaving the `b`
                            node
                        </span><span class="c2"><br></span><span class="c7 c4"># </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; Printing the assembly instruction
                            for (+ a b)
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; %rbx =
                            a
                        </span><span class="c2"><br></span><span class="c7 c4"># &nbsp; &nbsp; %r10 = b</span><span class="c2"><br></span><span class="c3">add</span><span class="c2">
                            &nbsp; &nbsp; %r10, %rbx
                        </span><span class="c7 c4"># %rbx = %rbx + %r10</span><span class="c2"><br></span><span class="c7 c4"># &nbsp; &nbsp; Marking %r10 as unused </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; Returning the name of the register
                            %rbx
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; %rbx contains the
                            value of `a + b`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp;
                            Leaving the `+` node of the subtree `(+ a b)`
                        </span><span class="c2"><br></span><span class="c7 c4"># </span><span class="c2"><br></span><span class="c7 c24 c4">
                            # &nbsp;
                            Recursively invoking the post-order function for the right subtree
                        </span>
                    </p>
                    <p class="c10">
                        <span class="c7 c4"># </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp;
                            &nbsp; Entering the `c` node of the subtree `[+ (+ a b) c]`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; Picking an unused register %r10 to
                            load the value `c` into it
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp;
                            &nbsp; Printing the assembly instruction
                        </span><span class="c2"><br></span><span class="c3">mov</span><span class="c2">&nbsp; &nbsp; c, &nbsp; &nbsp;%r10<br></span><span class="c7 c4"># &nbsp; &nbsp; Returning the name of the register %r10</span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; %r10 contains the value at the
                            address `c`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; &nbsp; Leaving
                            the `c` node
                        </span><span class="c2"><br></span><span class="c7 c4"># </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; Printing the assembly instruction for `[+
                            (+ a b) c]`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; %rbx = a +
                            b
                        </span><span class="c2"><br></span><span class="c7 c4"># &nbsp; %r10 = c</span><span class="c2"><br></span><span class="c3">add</span><span class="c2">
                            &nbsp; &nbsp; %r10, %rbx
                        </span><span class="c7 c4"># %rbx = %rbx + %r10</span><span class="c2"><br></span><span class="c7 c4"># &nbsp; Marking %r10 as unused</span><span class="c2"><br></span><span class="c7 c4"># &nbsp; Returning the name of the register %rbx</span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; %rbx contains the value of `(a + b) +
                            c`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; Leaving the `+` node of
                            the subtree `[+ (+ a b) c]`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            #
                        </span><span class="c2"><br></span><span class="c7 c4 c24">
                            # Recursively invoking the post-order
                            function for the right subtree
                        </span>
                    </p>
                    <p class="c10">
                        <span class="c7 c4"># </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp;
                            Entering the `d` node of the tree `(+ [+ (+ a b) c] d)`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; Picking an unused register %r10 to load
                            the value `d` into it
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp;
                            Printing the assembly instruction
                        </span><span class="c2"><br></span><span class="c3">mov</span><span class="c2">&nbsp; &nbsp; d, &nbsp; &nbsp;%r10<br></span><span class="c7 c4"># &nbsp; Returning the name of the register %r10</span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; %r10 contains the value at the address
                            `d`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # &nbsp; Leaving the `d`
                            node
                        </span><span class="c2"><br></span><span class="c7 c4">#</span><span class="c2"><br></span><span class="c7 c4">
                            # Printing the assembly instruction for `(+ [+ (+
                            a b) c] d)`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # %rbx = (a + b) +
                            c
                        </span><span class="c2"><br></span><span class="c7 c4"># %r10 = d</span><span class="c2"><br></span><span class="c3">add</span><span class="c2">
                            &nbsp; &nbsp; %r10,
                            %rbx<br>
                        </span><span class="c7 c4"># Marking %r10 as unused</span><span class="c2"><br></span><span class="c7 c4">
                            # Returning the name of the register
                            %rbx
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # %rbx contains the value of `((a
                            + b) + c) + d`
                        </span><span class="c2"><br></span><span class="c7 c4">
                            # Leaving the root `+`
                            node
                        </span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <hr style="page-break-before:always;display:none;">
    <p class="c14 c35"><span class="c0"></span></p>
    <p class="c14">
        <span>Yippee, we translated an expression into assembly code! The </span><span class="c4">%rbx</span><span class="c0">
            &nbsp;register will contain the expression&rsquo;s value at runtime.
            Let&rsquo;s feast our eyes on the result one last time.
        </span>
    </p><a id="t.2b5deb74d4ec92dc69533d34b22f12db5e46a831"></a><a id="t.10"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c40" colspan="1" rowspan="1">
                    <p class="c27"><span class="c0">Expression</span></p>
                </td>
                <td class="c33" colspan="1" rowspan="1">
                    <p class="c27"><span class="c0">Assembly (using AT&amp;T syntax)</span></p>
                </td>
            </tr>
            <tr class="c6">
                <td class="c40 c47" colspan="1" rowspan="1">
                    <p class="c10"><span class="c2">a + b + c + d</span></p>
                </td>
                <td class="c33 c47" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c3">mov</span><span class="c2">
                            &nbsp; &nbsp; a, &nbsp;
                            &nbsp;%rbx<br>
                        </span><span class="c3">mov</span><span class="c2">
                            &nbsp; &nbsp; b, &nbsp;
                            &nbsp;%r10<br>
                        </span><span class="c3">add</span><span class="c2">
                            &nbsp; &nbsp; %r10,
                            %rbx<br>
                        </span><span class="c3">mov</span><span class="c2">
                            &nbsp; &nbsp; c, &nbsp;
                            &nbsp;%r10<br>
                        </span><span class="c3">add</span><span class="c2">
                            &nbsp; &nbsp; %r10,
                            %rbx<br>
                        </span><span class="c3">mov</span><span class="c2">
                            &nbsp; &nbsp; d, &nbsp;
                            &nbsp;%r10<br>
                        </span><span class="c3">add</span><span class="c2 c24 c50">
                            &nbsp; &nbsp; %r10,
                            %rbx
                        </span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c5">
        <span>The method </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/Translator.fs#L40">Translator.Translate</a>
        </span><span>
            &nbsp;kicks
            off assembly generation by invoking
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/ProgramTranslator.fs#L246">ProgramTranslator.Translate</a>
        </span><span>
            .
            There are multiple classes responsible for emitting assembly:
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/ProgramTranslator.fs#L16">ProgramTranslator</a>
        </span><span>
            ,
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/ClassTranslator.fs#L13">ClassTranslator</a>
        </span><span>
            ,
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/ExprTranslator.fs#L15">ExprTranslator</a>
        </span><span>&nbsp;and</span><span>&nbsp;</span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/LibCool/TranslatorParts/AsmBuilder.fs#L15">AsmBuilder</a>
        </span><span>.</span>
    </p>
    <h1 class="c5" id="h.kmpuxj6z33q8"><span class="c1">Runtime library</span></h1>
    <p class="c5">
        <span class="c0">
            A number of built-in classes are available in Cool 2020. Additionally, although they
            are not directly accessible from user code, there are procedures for allocating memory, copying objects, and
            several procedures for aborting a program in various invalid scenarios. Another important element of our
            runtime is the entry point that transfers control to user code, we&rsquo;ll discuss it in more details
            later.
        </span>
    </p>
    <p class="c5">
        <span class="c0">All the code described above lives in the runtime library (or simply runtime).</span>
    </p>
    <p class="c5">
        <span class="c0">
            Stanford&rsquo;s Compilers course gives students a pre-made runtime library. It
            targets the MIPS architecture, assumes a Unix-like operating system and implements the classes built into
            the Cool language.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            At the same time, we decided to emit x86-64 assembly code, target Windows and Linux,
            and our language is a Scala subset &mdash; its built-in classes and the built-in classes of Stanford&rsquo;s
            Cool are different.
        </span>
    </p>
    <p class="c5">
        <span class="c0">
            By now, the attentive reader will have noticed, the runtime library from the
            Compilers course is not going to work for us as is. Instead, we can study its code and apply the gained
            insights to roll our own runtime library.
        </span>
    </p>
    <p class="c5">
        <span class="c12">
            <a class="c11" href="https://godbolt.org/">
                Compiler
                Explorer
            </a>
        </span><span>
            &nbsp;(aka &mdash; godbolt.org) is a great help in writing relatively complex
            assembly code. For example, I used it to implement the string to number routine. I implemented the algorithm
            in C and used Compiler Explorer to
        </span><span class="c12">
            <a class="c11"
               href="https://godbolt.org/z/zq3fb5">
                translate
                it into assembly code
            </a>
        </span><span class="c0">
            . It took a lot of cleaning up to arrive at the final
            version of the code, but writing it from scratch would&rsquo;ve been much, much harder for me.
        </span>
    </p>
    <h2 class="c26" id="h.f50fls6tbx64"><span class="c19">What can our runtime do?</span></h2>
    <p class="c5">
        <span>The runtime is made up of three parts. One is </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/Runtime/rt_common.s">rt_common.s</a>
        </span><span>
            .
            Just as the name suggests, it&rsquo;s common code that doesn&rsquo;t depend on the platform. rt_common.s
            contains the process entry point &mdash; the routine
        </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/Runtime/rt_common.s#L1573">main</a>
        </span><span>
            .
            It&rsquo;s responsible for invoking the platform-dependent code&rsquo;s initialization procedure, creating
            an instance of the class
        </span><span class="c4">Main</span><span>
            &nbsp;and invocation of the constructor.
            Exiting the process is something
        </span><span class="c4">main</span><span>
            &nbsp;is responsible for
            too.
        </span>
    </p>
    <hr style="page-break-before:always;display:none;">
    <p class="c5 c35"><span class="c0"></span></p>
    <p class="c5"><span class="c0">Here&rsquo;s a look at the entry point&rsquo;s code.</span></p><a id="t.6a6e0fe6c02681389a2e1035d73654b5de3cd0bb"></a><a id="t.11"></a>
    <table class="c37">
        <tbody>
            <tr class="c6">
                <td class="c45" colspan="1" rowspan="1">
                    <p class="c27"><span class="c0">Assembly (using AT&amp;T syntax)</span></p>
                </td>
                <td class="c45" colspan="1" rowspan="1">
                    <p class="c27"><span class="c0">Pseudocode</span></p>
                </td>
            </tr>
            <tr class="c6">
                <td class="c41" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c36 c46">&nbsp; .global</span><span class="c2">&nbsp;main<br></span><span class="c4 c34">main:</span><span class="c2">
                            <br>
                            &nbsp;
                        </span><span class="c3">call</span><span class="c2">
                            &nbsp; .Platform.init<br><br>
                            &nbsp;
                        </span><span class="c7 c24 c4"># A class &#39;Main&#39; must be present</span>
                    </p>
                    <p class="c10"><span class="c7 c24 c4">&nbsp; # in every Cool2020 program.</span></p>
                    <p class="c10">
                        <span class="c2">&nbsp; </span><span class="c7 c4">
                            # Create a new instance of
                            &#39;Main&#39;.
                        </span><span class="c2"><br> &nbsp;</span><span class="c3">movq</span><span class="c2">&nbsp; $Main_proto_obj, %rdi<br> &nbsp;</span><span class="c3">call</span><span class="c2">&nbsp; .Runtime.copy_object<br><br> &nbsp;</span><span class="c7 c24 c4">
                            #
                            &#39;Main..ctor&#39; is a Cool2020
                        </span>
                    </p>
                    <p class="c10">
                        <span class="c7 c4">&nbsp; # program&#39;s entry point.</span><span class="c2">
                            <br>
                            &nbsp;
                        </span><span class="c7 c24 c4"># Pass a reference to the newly </span>
                    </p>
                    <p class="c10">
                        <span class="c7 c4">&nbsp; # </span><span class="c7 c4">created</span><span class="c7 c4">&nbsp;&#39;Main&#39; instance in %rdi.</span><span class="c2">
                            <br>
                            &nbsp;
                        </span><span class="c7 c4"># Invoke the constructor.</span><span class="c2">
                            <br>
                            &nbsp;
                        </span><span class="c3">movq</span><span class="c2">
                            &nbsp; %rax, %rdi<br>
                            &nbsp;
                        </span><span class="c3">call</span><span class="c2">
                            &nbsp; Main..ctor<br><br>
                            &nbsp;xorq &nbsp;%rdi, %rdi<br> &nbsp;
                        </span><span class="c3">jmp</span><span class="c2">&nbsp; &nbsp;.Platform.exit_process</span>
                    </p>
                </td>
                <td class="c41" colspan="1" rowspan="1">
                    <p class="c10">
                        <span class="c3">def </span><span class="c25">main</span><span class="c3">
                            () = {<br>
                            &nbsp;.
                        </span><span class="c9">Platform</span><span class="c3">
                            .init();<br><br> &nbsp;new
                        </span><span class="c9">Main</span><span class="c3">();<br><br> &nbsp;.</span><span class="c9">Platform</span><span class="c3">.exit_process(</span><span class="c13 c36 c51">0</span><span class="c3">)<br>}</span>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>
    <p class="c5">
        <span class="c0">
            Also, rt_common.s contains the code of constructors and methods of the built-in
            classes.
        </span>
    </p>
    <ul class="c38 lst-kix_oc0tsm47xpne-0 start">
        <li class="c14 c21 li-bullet-0">
            <span class="c12 c4">
                <a class="c11"
                   href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/Runtime/rt_common.s#L1383">IO</a>
            </span><span class="c0">&nbsp;includes input/output methods;</span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span class="c12 c4">
                <a class="c11"
                   href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/Runtime/rt_common.s#L1228">ArrayAny</a>
            </span><span>
                &nbsp;is
                a class representing arrays with the element type
            </span><span class="c4">Any</span><span class="c0">;</span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span class="c12 c4">
                <a class="c11"
                   href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/Runtime/rt_common.s#L750">String</a>
            </span><span>
                &nbsp;is
                a class representing strings, in particular it has the
            </span><span class="c12 c4">
                <a class="c11"
                   href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/Runtime/rt_common.s#L949">concat</a>
            </span><span>
                &nbsp;and
            </span><span class="c12 c4">
                <a class="c11"
                   href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/Runtime/rt_common.s#L1090">substring</a>
            </span><span class="c0">&nbsp;methods;</span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span class="c0">
                There are a couple of other classes as well, but we&rsquo;ll
                discuss them another time;
            </span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span>
                As I mentioned earlier, the routine for copying objects and several
                procedures for the program&#39;s abnormal termination: in case of accessing a null reference, going out
                of bounds of an array, etc.
            </span>
            <hr style="page-break-before:always;display:none;">
        </li>
    </ul>
    <p class="c14">
        <span>The platform-specific </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/2d96bb8adf30ba3f5b839ed99f312317ff3fccbb/src/Runtime/rt_windows.s">rt_windows.s</a>
        </span><span>
            &nbsp;and
        </span><span class="c12">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/84c9c523abf742239e652bcd89da0c1498de44ac/src/Runtime/rt_linux.s">rt_linux.s</a>
        </span><span class="c0">&nbsp;each contain five procedures.</span>
    </p>
    <ul class="c38 lst-kix_oc0tsm47xpne-0">
        <li class="c14 c21 li-bullet-0">
            <span class="c4">.Platform.init</span><span class="c0">
                &nbsp;is responsible for
                platform-specific initialization. At the moment, this is preparation for memory allocation during
                program execution;
            </span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span>And </span><span class="c4">.Platform.alloc</span><span class="c0">&nbsp;is the memory allocation procedure;</span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span class="c4">.Platform.out_string</span><span>&nbsp;and </span><span class="c4">.Platform.in_string</span><span>&nbsp;write a string to </span><span class="c4">stdout</span><span>&nbsp;and read from </span><span class="c4">stdin</span><span class="c0">
                ,
                respectively;
            </span>
        </li>
        <li class="c14 c21 li-bullet-0">
            <span>And, finally, the most important procedure </span><span class="c4">.Platform.exit_process</span><span>&nbsp;is responsible for ending the process.</span>
        </li>
    </ul>
    <p class="c14">
        <span>
            What else is necessary to make the runtime cross-platform? Of course, the end of
        </span><span>line constant</span><span>. Both rt_windows and rt_linux define a label </span><span class="c4">.Platform.ascii_new_line</span><span>
            &nbsp;pointing at the respective end of line characters
            sequence.
        </span>
    </p>
    <p class="c14">
        <span class="c0">
            rt_windows.s and rt_linux.s are fully self-contained. As in they don&rsquo;t depend
            on the standard C library or any other library. Instead they work directly with Win API on Windows and
            system calls on Linux.
        </span>
    </p>
    <p class="c14">
        <span>So how do we make a Win API call from assembly code? First, we follow </span><span class="c12">
            <a class="c11"
               href="https://sonictk.github.io/asm_tutorial/#windows:thewindowtothehardware/themicrosoftx64callingconvention">
                The
                Microsoft x64 Calling Convention
            </a>
        </span><span>
            . Second, it is very important to understand and keep
            in mind the concept of
        </span><span class="c12">
            <a class="c11"
               href="https://sonictk.github.io/asm_tutorial/#windows:thewindowtothehardware/themicrosoftx64callingconvention/theshadowspace">
                shadow
                space
            </a>
        </span><span>.</span>
    </p>
    <p class="c14">
        <span>
            Things are a bit simpler on Linux: we don&rsquo;t have to worry about the shadow space when
            performing a system call. We still need to stick to the platform&rsquo;s calling conventions &mdash; for
            Linux it&rsquo;s
        </span><span class="c12">
            <a class="c11" href="https://wiki.osdev.org/System_V_ABI">
                System
                V ABI
            </a>
        </span><span>
            . One place where you can find the list of system calls, their parameters and
            short descriptions is
        </span><span class="c12">
            <a class="c11"
               href="https://chromium.googlesource.com/chromiumos/docs/+/HEAD/constants/syscalls.md">
                Linux
                System Call Table
            </a>
        </span><span class="c0">&nbsp;from Chromium OS Docs.</span>
    </p>
    <h2 class="c53" id="h.lpnb9m9ut0ct"><span>What our runtime can not do?</span></h2>
    <p class="c5">
        <span class="c0">
            It cannot make coffee. And it cannot collect garbage. At the moment, Cool 2020
            programs allocate memory but never free it up in the course of their execution. Eventually, we&rsquo;ll add
            a generational garbage collector inspired by the one from Stanford&rsquo;s Compilers course to the runtime.
            And for now, we&rsquo;ll just pretend we already have a garbage collector &mdash; fake it till you make
            it!
        </span>
    </p>
    <p class="c5"><span class="c0">There are officially no plans of adding coffee making routines.</span></p>
    <h1 class="c5" id="h.xgfmx7f6u5ae"><span class="c1">Executable linking</span></h1>
    <p class="c5">
        <span class="c0">
            Whew! We took a Cool 2020 program as the input and emitted assembly code as the
            output. The runtime&rsquo;s code that the emitted assembly depends on is also in place. Not that much left
            to do to finally turn all of these into an executable.
        </span>
    </p>
    <p class="c5">
        <span>For starters, we need an </span><span class="c12">
            <a class="c11"
               href="https://en.wikipedia.org/wiki/Assembly_language#Assembler">assembler</a>
        </span><span>
            &nbsp;that
            translates assembly code into machine code packaged into an
        </span><span class="c12">
            <a class="c11"
               href="https://en.wikipedia.org/wiki/Object_file">
                object
                file
            </a>
        </span><span class="c0">
            . In other words, the assembler assembles assembly &mdash; programming
            is not without poetry, don&rsquo;t you think?
        </span>
    </p>
    <p class="c5">
        <span>
            Although object files contain machine code &mdash; i.e. the code that can be directly executed
            on the target CPU &mdash; &nbsp;we cannot run them just yet. We&rsquo;ll need to combine the object files
            generated from the user code and from the runtime code into an executable using a
        </span><span class="c12"><a class="c11" href="https://en.wikipedia.org/wiki/Linker_(computing)">linker</a></span><span class="c0">.</span>
    </p>
    <p class="c5">
        <span>
            As we&rsquo;re aiming to have the compiler cross-platform, it makes sense to go for the
            assembler and linker from
        </span><span class="c12">
            <a class="c11"
               href="https://www.gnu.org/software/binutils/">
                GNU
                Binutils
            </a>
        </span><span class="c0">&nbsp;&mdash; as and ld.</span>
    </p>
    <p class="c5">
        <span>
            For Linux it&rsquo;s a package basically every distro has. To give a specific example, on Ubuntu
            the package name is
        </span><span class="c4">binutils</span><span>.</span>
    </p>
    <p class="c5">
        <span>
            Installing GNU Binutils on Windows is really simple too. MinGW includes the utilities in the
            distribution. If you don&rsquo;t know what MinGW is, don&rsquo;t bother right now. The important thing here
            is after installing it, we&rsquo;ll have as and ld.
        </span><span class="c12">
            <a class="c11"
               href="https://code.visualstudio.com/docs/cpp/config-mingw#_prerequisites">
                Item
                3 on this page
            </a>
        </span><span>
            &nbsp;explains where to get a MinGW graphical installer from and how to
            use it. (
        </span><span class="c17">
            Advanced users can opt for an alternative way of obtaining MinGW. Install
        </span><span class="c12 c4 c17">
            <a class="c11"
               href="https://www.msys2.org/#installation">MSYS2</a>
        </span><span class="c17">
            . You now have
        </span><span class="c4 c17">bash</span><span class="c17">&nbsp;and </span><span class="c4 c17">pacman</span><span class="c17">. Say </span><span class="c4 c17">
            pacman -S
            mingw-w64-x86_64-toolchain
        </span><span class="c17">&nbsp;to get the latest version of </span><span class="c4 c17">MinGW</span><span class="c17">.</span><span class="c0">)</span>
    </p>
    <p class="c5">
        <span>On Windows, remember</span><span>&nbsp;to add the path to as and ld to the </span><span class="c4">PATH</span><span>
            &nbsp;environment variable. Otherwise, our compiler won&rsquo;t find them and
            will fail to generate executables.
        </span>
    </p>
    <p class="c5">
        <span>The </span><span class="c12 c4">
            <a class="c11"
               href="https://github.com/mykolav/coollang-2020-fs/blob/3dcaba091fc89f5ef260e9e4a6a531b1ef32375a/src/LibCool/DriverParts/EmitExeHandler.fs#L50">EmitExeHandler.Invoke</a>
        </span><span class="c0">&nbsp;is the method that runs as and ld and checks the results of their work.</span>
    </p>
    <p class="c5">
        <span>
            And so, we have reached the point where our compiler can create executables from Cool 2020
            programs! Now we have everything we need to record that GIF from
        </span><span class="c12">
            <a class="c11"
               href="#h.inqmlkner7vi">&quot;How are we going to compile?&quot;</a>
        </span><span class="c0">.</span>
    </p>
    <h1 class="c5" id="h.5m4187ahcjun"><span>Intermediate representations and optimizations</span></h1>
    <p class="c5">
        <span class="c0">
            Our compiler does not generate an intermediate representation (IR) of the program and
            does not perform any optimizations. Intermediate representations and code optimizations are extremely
            important, probably the most important, topics in compiler development, but working on them also takes a lot
            of time and effort. For this reason, I opted for taking them out of this project&rsquo;s scope, at least for
            now. Hopefully, it doesn&rsquo;t take away from studying the fundamentals of compilers. Better still,
            understanding IR and optimizations is much easier when you have a solid understanding of the basics.
        </span>
    </p>
    <p class="c5">
        <span>
            Anyway, intermediate representations and optimizations are exceptionally important and very
            interesting topics in compiler development. That&rsquo;s why teams of enterprise-grade compilers as well as
            computer scientists work really hard on them. How fast compiled programs work and their memory consumption
            directly depends on the optimizations compilers perform. There are a couple of links explaining these things
            in more detail in the
        </span><span class="c12">
            <a class="c11" href="#h.6vmw7qq6gu">
                &ldquo;Advanced
                topics&rdquo;
            </a>
        </span><span class="c0">&nbsp;section.</span>
    </p>
    <h1 class="c5" id="h.nhx0ymn32qxg"><span class="c1">If you want to learn about compilers</span></h1>
    <p class="c5">
        <span>Cannot recommend highly enough the book </span><span class="c12">
            <a class="c11"
               href="https://craftinginterpreters.com/contents.html">
                Crafting
                Interpreters
            </a>
        </span><span>&nbsp;by Robert Nystrom.</span><span class="c0">
            Don&rsquo;t let the word
            Interpreters in the book&rsquo;s title discourage you. Compilers and interpreters have a lot in common and
            until you get to the topics specific to interpreters, you&rsquo;ll gain a ton of useful knowledge. The
            author has a real talent for explaining things in a very clear and precise manner.
        </span>
    </p>
    <p class="c5">
        <span class="c12">
            <a class="c11" href="https://www.edx.org/course/compilers">
                Alex
                Aiken, Compilers
            </a>
        </span><span>. This is basically a classic on compilers. </span><span>
            A
            Stanford
        </span><span class="c0">
            &nbsp;professor Alex Aiken created the course. As you would expect, compared
            to Crafting Interpreters, the course&rsquo;s lectures focus on the theoretical aspects much more. To give an
            example, where Crafting Interpreters only mentions LR(1) parsing existence, the Compilers course goes into
            details about it.
        </span>
    </p>
    <p class="c5">
        <span>
            For some reasons, the Compilers course, just as many other compiler studying materials,
            discusses emitting assembly code targeting the MIPS architecture. But x86-64 assembly is a better fit for
            our specific project. For this reason, a freely available book
        </span><span class="c12">
            <a class="c11"
               href="https://www3.nd.edu/~dthain/compilerbook/">
                Introduction
                to Compilers and Language Design
            </a>
        </span><span class="c0">
            &nbsp;by Douglas Thain is very useful to us.
            As, among other things, the book explains how to work with the x86-64 assembly and how to translate
            different constructs of high-level languages into it.
        </span>
    </p>
    <p class="c5">
        <span>Who&rsquo;s gonna watch a Fortnite stream on Twitch, when Immo Landwerth is </span><span class="c12">
            <a class="c11"
               href="https://www.youtube.com/watch?v=wgHIkdUQbp0&list=PLRAdsfhKI4OWNOSfS7EUu5GRAVmze1t2y">
                writing
                a compiler
            </a>
        </span><span>
            &nbsp;live on YouTube?! Of course, records of the live streams are available
            as well and you can explore the code in
        </span><span class="c12">
            <a class="c11"
               href="https://github.com/terrajobst/minsk">
                the
                project&rsquo;s github repo
            </a>
        </span><span class="c0">.</span>
    </p>
    <h2 class="c26" id="h.6vmw7qq6gu"><span>Advanced topics</span></h2>
    <p class="c5">
        <span>
            A talk on intermediate representations (IR). Previous knowledge is not required. What&rsquo;s so
            cool about this talk is that it&rsquo;s built around one of the most widely used IR &mdash; LLVM IR.
        </span><span class="c12">
            <a class="c11" href="https://www.youtube.com/watch?v=m8G_S5LwlTo">
                2019
                EuroLLVM Developers&rsquo; Meeting: V. Bridgers &amp; F. Piovezan &ldquo;LLVM IR Tutorial - Phis, GEPs
                ...&rdquo;
            </a>
        </span>
    </p>
    <p class="c5">
        <span>
            A free self-guided online course from Cornell University. Goes in depth on IR and optimizations
            but is very accessible at the same time. Again, cannot recommend highly enough.
        </span><span class="c12">
            <a class="c11" href="https://www.cs.cornell.edu/courses/cs6120/2020fa/self-guided/">
                CS
                6120: Advanced Compilers: The Self-Guided Online Course
            </a>
        </span><span class="c0">.</span>
    </p>

    <a href="https://github.com/mykolav/coollang-2020-fs" class="github-corner" aria-label="View source on GitHub">
        <svg width="80" height="80" viewBox="0 0 250 250" style="position: fixed; top: 0px; right: 0px; border: 0px;"
             aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" fill="#151513"></path>
            <path class="octo-arm"
                  d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                  fill="#ffffff" style="transform-origin: 130px 106px;"></path>
            <path class="octo-body"
                  d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                  fill="#ffffff"></path>
        </svg>
    </a>
</body>
</html>